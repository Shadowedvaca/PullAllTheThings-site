# Shadowedvaca.com — Common Services Conversion Plan

> This document describes how to evolve shadowedvaca.com from a static Jinja2-built site
> to one that can leverage the common services layer built for the PATT platform.
> It is written for Mike's agent working on the shadowedvaca.com project.

---

## Current State

Shadowedvaca.com is a static site generated by a Python build script:
- **Build system:** Jinja2 templates + Pydantic schemas → static HTML
- **Data:** JSON files (projects.json, announcements.json, profile.json)
- **Hosting:** Nginx serving static files from `/var/www/shadowedvaca.com/` on Hetzner
- **Design:** Split-screen "command center" dashboard (retro CRT terminal + main stage)
- **Existing pages:** Meandering Muck press kit, support, privacy pages

The site has no backend — the Python script runs at build time and produces static HTML
files that Nginx serves directly.

---

## What the PATT Platform Provides

The PATT platform (pullallthething.com) introduces shared Python packages at
`/opt/patt-platform/src/sv_common/` that handle:

| Package | What It Does |
|---------|-------------|
| `sv_common.auth` | JWT tokens, password hashing, invite codes |
| `sv_common.discord` | Bot client, role sync, DM dispatch, channel posting |
| `sv_common.identity` | Guild member model, rank management, character CRUD |
| `sv_common.notify` | Channel-agnostic message routing |
| `sv_common.db` | SQLAlchemy engine, ORM models, database sessions |

These packages talk to the shared PostgreSQL database on the same Hetzner server.

---

## Conversion Strategy

### Principle: Don't Break What Works

Shadowedvaca.com works. It's a clean static site. The conversion should be **incremental**
— add backend capabilities when they provide clear value, don't rebuild what doesn't need it.

### Phase A: Package Access (No Backend Yet)

**Goal:** The shadowedvaca.com build script can import `sv_common` packages.

**How:**
1. Add `sv_common` to the Python path in shadowedvaca.com's build environment
2. Option 1: Symlink `/opt/patt-platform/src/sv_common` into shadowedvaca's venv
3. Option 2: Install `sv_common` as a proper pip package (create setup.py/pyproject.toml in patt-platform)
4. Option 3: Add `/opt/patt-platform/src` to `PYTHONPATH` in the build script

**Recommendation:** Option 2. Make `sv_common` a proper installable package. This is the
cleanest long-term approach and means any project on the server can `pip install sv_common`.

**What this enables:**
- The build script can query the database for live data (project status, announcement counts)
- Data doesn't have to live in JSON files anymore (but can as a fallback)
- The build still produces static HTML — just sourced from the database instead of JSON

### Phase B: Add a Backend (When Needed)

**Goal:** Shadowedvaca.com gets a FastAPI backend for features that require dynamic behavior.

**When to do this:** When you want any of:
- User authentication (login, member profiles)
- Dynamic data (live project status, real-time updates)
- Form submissions (contact form, feedback)
- Integration with sv-tools via MCP
- Show Planner or Raid Team Manager interactive demos

**How:**
1. Create a FastAPI app for shadowedvaca.com (similar structure to PATT app)
2. Import `sv_common` packages for auth, DB, etc.
3. Update Nginx to proxy dynamic routes to the new backend:
   ```nginx
   # Static assets stay fast
   location /static/ {
       alias /var/www/shadowedvaca.com/static/;
   }

   # Existing static pages (build output)
   location / {
       try_files $uri $uri/ @backend;
   }

   # Dynamic routes go to backend
   location @backend {
       proxy_pass http://127.0.0.1:8200;  # Different port than PATT
   }
   ```
4. The hybrid approach: static pages for content, backend for interactive features

### Phase C: Shared Database Schemas

**Goal:** Shadowedvaca.com has its own schema in the shared PostgreSQL database.

**How:**
1. Add a `shadowedvaca` schema to the database:
   ```sql
   CREATE SCHEMA shadowedvaca AUTHORIZATION patt_user;
   ```
2. Add models for shadowedvaca-specific data (projects, announcements, etc.)
3. Migrate project data from JSON files to database tables
4. The build script reads from DB → generates static HTML (same output, different source)
5. Admin UI for managing projects, announcements (optional — JSON files work fine for low-change-rate content)

---

## Specific Integration Opportunities

### 1. Project Status Sync
The command center shows project status (active, upcoming, archived). If project status
is tracked in the database, the PATT platform's campaign system could reference it
(e.g., "Vote on the next feature for Show Planner").

### 2. Shared Auth
If both sites share `sv_common.auth`, a user logged into pullallthething.com could
seamlessly access authenticated features on shadowedvaca.com. The JWT tokens would
be valid across both domains (same secret key, same user table).

Cross-domain auth requires either:
- A shared parent domain cookie (not applicable — different domains)
- Token passing via URL parameter on redirect
- A central auth service with OAuth-style redirects

**Recommendation:** Defer cross-domain auth until there's a clear use case. Keep auth
per-site for now.

### 3. Discord Integration
The PATT-Bot could serve both sites. When Mike updates a project on shadowedvaca.com,
the bot could announce it in the guild Discord. Same bot, same channel posting code,
triggered from a different app.

### 4. Notification System
`sv_common.notify` can dispatch messages from any app. Shadowedvaca.com could send
notifications about Meandering Muck updates, podcast episode releases, etc.

---

## Recommended Conversion Order

1. **Now:** Build the PATT platform and `sv_common` packages (this is happening)
2. **After PATT is stable:** Package `sv_common` as an installable Python package
3. **When shadowedvaca.com needs dynamic features:** Add a FastAPI backend
4. **When data management gets painful:** Migrate from JSON to database
5. **When cross-site features are wanted:** Implement shared auth or bot integration

Don't rush it. The common services layer is being built by the PATT platform.
Shadowedvaca.com benefits from it naturally as the packages mature.

---

## File Structure After Conversion

```
Hetzner Server
├── /opt/patt-platform/                    ← PATT app + sv_common source
│   └── src/sv_common/                     ← Shared packages (installed as pip package)
│
├── /opt/shadowedvaca-site/                ← Shadowedvaca app
│   ├── packages/core/                     ← Existing Pydantic schemas
│   ├── packages/site/                     ← Existing Jinja2 build
│   ├── data/                              ← JSON data (or DB reads)
│   ├── dist/                              ← Built static output
│   ├── app.py                             ← FastAPI backend (Phase B)
│   └── requirements.txt                   ← includes sv_common
│
├── /var/www/shadowedvaca.com/             ← Nginx serves from here
│   └── (symlink or copy from dist/)
│
├── PostgreSQL
│   ├── common.*                           ← Shared data
│   ├── patt.*                             ← PATT data
│   └── shadowedvaca.*                     ← Shadowedvaca data (Phase C)
```

---

## Key Decisions for Mike's Agent

When your agent starts the conversion, these decisions need to be made:

1. **When does shadowedvaca.com need a backend?** If it's just content updates, JSON + build script is fine. If interactive features are needed, add the backend.

2. **How is sv_common distributed?** pip package is cleanest. The PATT platform should publish it. The agent should check whether this has been done yet.

3. **Database vs JSON for content?** For a small portfolio site with infrequent updates, JSON files are honestly fine. The database adds value when there are multiple editors, frequent changes, or data shared across sites.

4. **Same PostgreSQL user or separate?** Recommendation: same database, same user, different schemas. Simplest to manage. If security isolation is needed later, create a separate DB user with access only to the shadowedvaca schema.
