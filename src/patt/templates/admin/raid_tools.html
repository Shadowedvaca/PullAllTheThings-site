{% extends "base_admin.html" %}
{% block title %}Raid Tools â€” Admin{% endblock %}
{% block nav_raid_tools %}active{% endblock %}

{% block head %}
<style>
/* â”€â”€ Form grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-grid {
    display: grid;
    grid-template-columns: 180px 1fr;
    gap: .5rem .9rem;
    max-width: 560px;
    align-items: center;
}
.form-grid label {
    font-size: .875rem;
    color: var(--color-text-muted);
    text-align: right;
}
.form-grid input,
.form-grid select,
.form-grid textarea {
    background: var(--color-bg);
    border: 1px solid var(--color-border-light);
    color: var(--color-text);
    border-radius: var(--radius-sm);
    padding: .4rem .6rem;
    font-size: .875rem;
    width: 100%;
    box-sizing: border-box;
}
.form-grid input:focus,
.form-grid select:focus,
.form-grid textarea:focus {
    outline: 2px solid var(--color-accent);
    border-color: var(--color-accent);
}
.form-grid textarea { height: 80px; resize: vertical; }

.btn-gold {
    background: var(--color-accent);
    color: #0a0a0b;
    font-weight: 600;
    border: none;
    padding: .45rem 1.1rem;
    border-radius: var(--radius-sm);
    font-size: .875rem;
    cursor: pointer;
}
.btn-gold:hover { background: #c4973c; }
.btn-outline-sm {
    background: transparent;
    border: 1px solid var(--color-border-light);
    color: var(--color-text-muted);
    padding: .45rem 1.1rem;
    border-radius: var(--radius-sm);
    font-size: .875rem;
    cursor: pointer;
}
.btn-outline-sm:hover { border-color: var(--color-accent); color: var(--color-accent); }

.status-msg { font-size: .85rem; }
.status-msg.ok  { color: var(--color-success); }
.status-msg.err { color: var(--color-danger); }

/* â”€â”€ Availability grid (compact clickable cards) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.day-grid-compact {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: .75rem;
    margin-bottom: 1rem;
}
@media (max-width: 1100px) {
    .day-grid-compact { grid-template-columns: repeat(4, 1fr); }
}

.day-card-sm {
    background: var(--color-bg-panel);
    border: 2px solid var(--color-border);
    border-radius: var(--radius);
    padding: .75rem;
    cursor: pointer;
    transition: border-color .15s;
}
.day-card-sm:hover { border-color: var(--color-accent); }
.day-card-sm.selected { border-color: var(--color-accent); background: rgba(212,168,75,.07); }
.day-card-sm__name {
    font-family: var(--font-display);
    font-size: .85rem;
    color: var(--color-text);
    margin: 0 0 .3rem;
}
.day-card-sm__bar { height: 6px; background: var(--color-bg-card); border-radius: 3px; overflow: hidden; margin-bottom: .3rem; }
.day-card-sm__fill { height: 100%; border-radius: 3px; }
.bar--green { background: var(--color-success); }
.bar--amber { background: var(--color-warning); }
.bar--red   { background: var(--color-danger); }
.day-card-sm__stats { font-size: .75rem; color: var(--color-text-muted); }
.day-card-sm__stats strong { color: var(--color-text); }

.role-bar { display: flex; gap: 2px; margin-top: .25rem; }
.role-seg { height: 4px; border-radius: 2px; }
.role-seg--tank   { background: #60a5fa; }
.role-seg--healer { background: #4ade80; }
.role-seg--melee  { background: #f87171; }
.role-seg--ranged { background: #fbbf24; }

/* â”€â”€ Day detail panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#day-detail {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1rem;
    margin-bottom: .75rem;
    display: none;
}
#day-detail.visible { display: block; }
.day-detail-title { font-family: var(--font-display); font-size: 1rem; color: var(--color-accent); margin: 0 0 .75rem; }
.role-summary { display: flex; gap: 1.25rem; margin-bottom: .75rem; font-size: .82rem; }

.player-table { width: 100%; border-collapse: collapse; font-size: .83rem; }
.player-table th {
    text-align: left; padding: .4rem .5rem;
    color: var(--color-text-muted); border-bottom: 1px solid var(--color-border);
    font-size: .78rem; text-transform: uppercase; letter-spacing: .04em;
}
.player-table td { padding: .35rem .5rem; border-bottom: 1px solid var(--color-border); color: var(--color-text); }
.player-table tr:last-child td { border-bottom: none; }
.player-table tr:hover td { background: rgba(255,255,255,.02); }

.role-pill {
    display: inline-block; font-size: .72rem; font-weight: 600;
    padding: .1rem .35rem; border-radius: 3px;
}
.role-pill--tank   { background: #1e3a5f; color: #60a5fa; }
.role-pill--healer { background: #143d22; color: #4ade80; }
.role-pill--melee  { background: #3d1414; color: #f87171; }
.role-pill--ranged { background: #3d2e05; color: #fbbf24; }

/* â”€â”€ Event Builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.builder-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0 2rem;
}
.builder-columns .form-grid { max-width: none; }

/* â”€â”€ Roster Preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.roster-preview-table { width: 100%; border-collapse: collapse; font-size: .83rem; margin-top: .75rem; }
.roster-preview-table th {
    text-align: left; padding: .4rem .5rem;
    color: var(--color-text-muted); border-bottom: 2px solid var(--color-border);
    font-size: .78rem; text-transform: uppercase; letter-spacing: .04em;
}
.roster-preview-table td { padding: .35rem .5rem; border-bottom: 1px solid var(--color-border); color: var(--color-text); vertical-align: middle; }
.roster-preview-table tr:last-child td { border-bottom: none; }
.roster-preview-table tr:hover td { background: rgba(255,255,255,.02); }

.status-badge {
    display: inline-block; font-size: .72rem; font-weight: 600;
    padding: .15rem .45rem; border-radius: 10px;
}
.status-badge--accepted  { background: #143d22; color: #4ade80; }
.status-badge--tentative { background: #3d2e05; color: #fbbf24; }
.status-badge--bench     { background: #2a2a2e; color: #888; }

.status-override select {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    color: var(--color-text);
    border-radius: var(--radius-sm);
    padding: .2rem .4rem;
    font-size: .78rem;
}

/* â”€â”€ Collapsible card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card-header.collapsible { cursor: pointer; user-select: none; }
.card-header.collapsible:hover .card-title { color: var(--color-text); }
.collapse-caret { font-size: .8rem; color: var(--color-text-muted); transition: transform .2s; }
.collapsed-body { display: none; }

/* â”€â”€ Manual fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fallback-box {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 1rem;
    font-family: var(--font-mono);
    font-size: .82rem;
    color: var(--color-text-muted);
    white-space: pre-wrap;
    word-break: break-word;
}

.roster-section-title {
    font-family: var(--font-display);
    font-size: .95rem;
    color: var(--color-accent);
    margin: 1.25rem 0 .5rem;
    display: flex;
    align-items: center;
    gap: .5rem;
}
.roster-section-title span {
    font-size: .75rem;
    color: var(--color-text-muted);
    font-family: var(--font-body);
}
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <div>
        <h1 class="admin-title">Raid Tools</h1>
        <p style="color:var(--color-text-muted);font-size:.9rem;margin-top:.2rem;">
            Configure Raid-Helper, review availability, and build events.
        </p>
    </div>
</div>

<div style="display:flex;flex-direction:column;gap:1.5rem;">

{# â”€â”€ Card 1: Raid-Helper Configuration (collapsed by default) â”€â”€ #}
<div class="card">
    <div class="card-header collapsible" onclick="toggleCard(this)">
        <span class="card-title">Raid-Helper Configuration</span>
        <span class="collapse-caret" style="transform:rotate(-90deg)">â–¼</span>
    </div>
    <div class="card-body collapsed-body">
        <div class="form-grid" id="rh-config-form">
            <label for="rh-api-key">API Key</label>
            <input type="password" id="rh-api-key"
                   value="{{ discord_config.raid_helper_api_key[:4] ~ '****' if discord_config and discord_config.raid_helper_api_key else '' }}"
                   placeholder="Paste new key to update">

            <label for="rh-server-id">Server ID</label>
            <input type="text" id="rh-server-id"
                   value="{{ discord_config.raid_helper_server_id or '' }}"
                   placeholder="Discord server snowflake">

            <label for="rh-creator-id">Creator Discord ID</label>
            <input type="text" id="rh-creator-id"
                   value="{{ discord_config.raid_creator_discord_id or '' }}"
                   placeholder="Discord user snowflake">

            <label for="rh-channel-id">Signup Channel ID</label>
            <input type="text" id="rh-channel-id"
                   value="{{ discord_config.raid_channel_id or '' }}"
                   placeholder="Discord channel snowflake">

            <label for="rh-voice-id">Voice Channel ID</label>
            <input type="text" id="rh-voice-id"
                   value="{{ discord_config.raid_voice_channel_id or '' }}"
                   placeholder="Optional">

            <label for="rh-template-id">Default Template</label>
            <input type="text" id="rh-template-id"
                   value="{{ discord_config.raid_default_template_id or 'wowretail2' }}"
                   placeholder="wowretail2">
        </div>
        <div class="form-actions" style="margin-top:.75rem;">
            <button class="btn-gold" onclick="saveRhConfig()">Save Config</button>
            <button class="btn-outline-sm" onclick="testRhConfig()">Test Connection</button>
            <span class="status-msg" id="rh-status"></span>
        </div>
    </div>
</div>

{# â”€â”€ Card 2: Availability by Day â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="card">
    <div class="card-header">
        <span class="card-title">Availability by Day</span>
        <span style="font-size:.8rem;color:var(--color-text-muted);">Click a day to populate the event builder</span>
    </div>
    <div class="card-body">
        <div class="day-grid-compact" id="day-grid"></div>
        <div id="day-detail">
            <div class="day-detail-title" id="day-detail-title">Available Players</div>
            <div class="role-summary" id="role-summary"></div>
            <table class="player-table">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Role</th>
                        <th>Rank</th>
                        <th>Earliest</th>
                    </tr>
                </thead>
                <tbody id="day-players"></tbody>
            </table>
        </div>
    </div>
</div>

{# â”€â”€ Card 3: Event Builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="card">
    <div class="card-header">
        <span class="card-title">Event Builder</span>
    </div>
    <div class="card-body">
        <p style="font-size:.85rem;color:var(--color-text-muted);margin:0 0 1.25rem;">
            Creates an event in Raid-Helper, saves it to the DB, and pre-populates signups from the roster.
            Click a day above to auto-fill, or fill in the fields manually for a one-off event.
        </p>
        <div class="builder-columns">
            {# Left column #}
            <div>
                <div class="form-grid">
                    <label for="ev-title">Title</label>
                    <input type="text" id="ev-title" placeholder="Heroic Raid Night" oninput="updateFallback()">

                    <label for="ev-type">Event Type</label>
                    <select id="ev-type" onchange="updateFallback()">
                        <option value="raid">Heroic/Mythic Raid</option>
                        <option value="oldraids">Old Raids / Achievements</option>
                        <option value="mythicplus">Mythic+</option>
                        <option value="pvp">PvP</option>
                        <option value="farming">Farming</option>
                        <option value="social">Social / Other</option>
                    </select>

                    <label for="ev-date">Date</label>
                    <input type="date" id="ev-date" onchange="updateFallback()">

                    <label for="ev-time">Time (EST)</label>
                    <input type="time" id="ev-time" value="21:00" onchange="updateFallback()">

                    <label for="ev-duration">Duration</label>
                    <select id="ev-duration" onchange="updateFallback()">
                        <option value="60">1 hour</option>
                        <option value="90">1.5 hours</option>
                        <option value="120" selected>2 hours</option>
                        <option value="150">2.5 hours</option>
                        <option value="180">3 hours</option>
                    </select>

                    <label for="ev-channel">Channel ID</label>
                    <input type="text" id="ev-channel"
                           value="{{ discord_config.raid_channel_id or '' }}"
                           placeholder="Discord channel ID">
                </div>
            </div>

            {# Right column #}
            <div>
                <div class="form-grid">
                    <label for="ev-desc" style="align-self:flex-start;margin-top:.3rem">Description</label>
                    <textarea id="ev-desc" placeholder="Weekly heroic clear. Sign up below!" oninput="updateFallback()"></textarea>
                </div>
            </div>
        </div>

        <div class="roster-section-title">
            Roster Preview
            <span>(auto-invite rules apply &middot; override per player below)</span>
        </div>
        <table class="roster-preview-table" id="roster-table">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Role</th>
                    <th>Rank</th>
                    <th>Auto-Invite</th>
                    <th>Status</th>
                    <th>Override</th>
                </tr>
            </thead>
            <tbody>
            {% for p in roster_players %}
            {% set rank_level = p.guild_rank.level if p.guild_rank else 0 %}
            {% set rank_name = p.guild_rank.name if p.guild_rank else 'â€”' %}
            {% set auto_inv = p.auto_invite_events %}
            {% if rank_level == 1 %}
                {% set default_status = 'bench' %}
            {% elif auto_inv %}
                {% set default_status = 'accepted' %}
            {% else %}
                {% set default_status = 'tentative' %}
            {% endif %}
            {% set spec_name = p.main_spec.name if p.main_spec else '' %}
            {% set role_name = p.main_spec.default_role.name if p.main_spec and p.main_spec.default_role else '' %}
            <tr data-player-id="{{ p.id }}" data-default-status="{{ default_status }}">
                <td>{{ p.display_name }}</td>
                <td>
                    {% if role_name %}
                    {% set role_css = {
                        'Tank': 'role-pill--tank',
                        'Healer': 'role-pill--healer',
                        'Melee DPS': 'role-pill--melee',
                        'Ranged DPS': 'role-pill--ranged'
                    } %}
                    <span class="role-pill {{ role_css.get(role_name, '') }}">{{ role_name }}</span>
                    {% else %}â€”{% endif %}
                </td>
                <td>{{ rank_name }}</td>
                <td style="color:{{ '#4ade80' if auto_inv else '#888' }}">
                    {{ 'Yes' if auto_inv else 'No' }}
                </td>
                <td class="status-cell">
                    <span class="status-badge status-badge--{{ default_status }}">
                        {{ default_status | capitalize }}
                    </span>
                </td>
                <td class="status-override">
                    <select onchange="overrideStatus({{ p.id }}, this.value)">
                        <option value="">â€” Auto â€”</option>
                        <option value="accepted">Accepted</option>
                        <option value="tentative">Tentative</option>
                        <option value="bench">Bench</option>
                        <option value="skip">Skip</option>
                    </select>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>

        <div class="form-actions" style="margin-top:1.25rem;">
            <button class="btn-gold" onclick="createEvent()">Create Event in Raid-Helper</button>
            <span class="status-msg" id="ev-status"></span>
        </div>
    </div>
</div>

{# â”€â”€ Card 4: Manual Fallback (collapsed by default) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="card">
    <div class="card-header collapsible" onclick="toggleCard(this)">
        <span class="card-title">Manual Fallback</span>
        <span class="collapse-caret" style="transform:rotate(-90deg)">â–¼</span>
    </div>
    <div class="card-body collapsed-body">
        <p style="font-size:.85rem;color:var(--color-text-muted);margin:0 0 .75rem;">
            Use this if Raid-Helper is down. Copy and paste into Discord.
        </p>
        <pre class="fallback-box" id="fallback-text">Fill in the Event Builder above to generate text here.</pre>
    </div>
</div>

</div>{# end card stack #}
{% endblock %}

{% block scripts %}
<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let availData = null;
let selectedDow = null;
let selectedRecurringEventId = null;
const playerOverrides = {};  // player_id (str) â†’ status string

// â”€â”€ Card collapse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleCard(header) {
    const body = header.nextElementSibling;
    const caret = header.querySelector('.collapse-caret');
    const hidden = body.classList.toggle('collapsed-body');
    if (caret) caret.style.transform = hidden ? 'rotate(-90deg)' : '';
}

// â”€â”€ Raid-Helper Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveRhConfig() {
    const status = document.getElementById('rh-status');
    status.textContent = 'Savingâ€¦';
    status.className = 'status-msg';

    const body = {
        raid_helper_api_key: document.getElementById('rh-api-key').value,
        raid_helper_server_id: document.getElementById('rh-server-id').value,
        raid_creator_discord_id: document.getElementById('rh-creator-id').value,
        raid_channel_id: document.getElementById('rh-channel-id').value,
        raid_voice_channel_id: document.getElementById('rh-voice-id').value,
        raid_default_template_id: document.getElementById('rh-template-id').value || 'wowretail2',
    };

    try {
        const resp = await fetch('/api/v1/admin/raid-config', {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body),
        });
        const data = await resp.json();
        if (data.ok) {
            status.textContent = 'âœ“ Saved';
            status.className = 'status-msg ok';
        } else {
            status.textContent = 'âœ— ' + (data.error || 'Error');
            status.className = 'status-msg err';
        }
    } catch (e) {
        status.textContent = 'âœ— ' + e.message;
        status.className = 'status-msg err';
    }
}

async function testRhConfig() {
    const status = document.getElementById('rh-status');
    status.textContent = 'Testingâ€¦';
    status.className = 'status-msg';
    try {
        const resp = await fetch('/api/v1/admin/raid-config/test');
        const data = await resp.json();
        if (data.ok) {
            status.textContent = `âœ“ Connected â€” ${data.data.server_name}`;
            status.className = 'status-msg ok';
        } else {
            status.textContent = 'âœ— ' + (data.error || 'Connection failed');
            status.className = 'status-msg err';
        }
    } catch (e) {
        status.textContent = 'âœ— ' + e.message;
        status.className = 'status-msg err';
    }
}

// â”€â”€ Availability grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function barClass(pct) {
    if (pct >= 70) return 'bar--green';
    if (pct >= 40) return 'bar--amber';
    return 'bar--red';
}

function rolePillClass(role) {
    const map = { 'Tank': 'role-pill--tank', 'Healer': 'role-pill--healer', 'Melee DPS': 'role-pill--melee', 'Ranged DPS': 'role-pill--ranged' };
    return map[role] || '';
}

function renderGrid(data) {
    availData = data;
    const grid = document.getElementById('day-grid');
    grid.innerHTML = '';
    for (const day of data.days) {
        const bc = barClass(day.availability_pct);
        const roles = day.role_breakdown || {};
        const total = day.available_count || 1;

        const roleOrder = [
            ['Tank', 'role-seg--tank'],
            ['Healer', 'role-seg--healer'],
            ['Melee DPS', 'role-seg--melee'],
            ['Ranged DPS', 'role-seg--ranged'],
        ];
        const roleSegs = roleOrder.map(([rn, rc]) => {
            const cnt = roles[rn] || 0;
            return cnt ? `<div class="role-seg ${rc}" style="flex:${cnt}"></div>` : '';
        }).join('');

        const eventHtml = day.recurring_event
            ? `<div style="font-size:.72rem;color:var(--color-accent);margin-bottom:.3rem">âš” ${day.recurring_event.label} Â· ${day.recurring_event.default_start_time}</div>`
            : '';

        const card = document.createElement('div');
        card.className = 'day-card-sm';
        card.dataset.dow = day.day_of_week;
        card.innerHTML = `
            <div class="day-card-sm__name">${day.day_name}</div>
            ${eventHtml}
            <div class="day-card-sm__bar"><div class="day-card-sm__fill ${bc}" style="width:${day.availability_pct}%"></div></div>
            <div class="day-card-sm__stats">
                <strong>${day.available_count}</strong> / ${availData.total_active_players} &middot; Wt <strong>${day.weighted_score}</strong>
            </div>
            <div class="role-bar">${roleSegs}</div>
        `;
        card.addEventListener('click', () => selectDay(day.day_of_week));
        grid.appendChild(card);
    }
}

function selectDay(dow) {
    document.querySelectorAll('.day-card-sm').forEach(c => {
        c.classList.toggle('selected', parseInt(c.dataset.dow) === dow);
    });
    selectedDow = dow;

    const day = availData.days[dow];
    selectedRecurringEventId = day.recurring_event ? day.recurring_event.id : null;

    const detail = document.getElementById('day-detail');
    detail.classList.add('visible');
    document.getElementById('day-detail-title').textContent =
        `${day.day_name} â€” ${day.available_count} available`;

    const roles = day.role_breakdown || {};
    const summaryEl = document.getElementById('role-summary');
    const roleOrder = ['Tank', 'Healer', 'Melee DPS', 'Ranged DPS'];
    summaryEl.innerHTML = roleOrder.map(r =>
        `<span><strong>${roles[r] || 0}</strong> ${r}</span>`
    ).join('');

    const tbody = document.getElementById('day-players');
    tbody.innerHTML = '';
    for (const p of day.players) {
        const rc = rolePillClass(p.main_role);
        const rolePill = p.main_role
            ? `<span class="role-pill ${rc}">${p.main_role}</span>`
            : 'â€”';
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.display_name}</td>
            <td>${rolePill}</td>
            <td>${p.rank || 'â€”'}</td>
            <td>${p.earliest_start || 'â€”'}</td>
        `;
        tbody.appendChild(tr);
    }

    const nextDate = nextOccurrenceOf(dow);
    document.getElementById('ev-date').value = nextDate;
    if (day.recurring_event) {
        document.getElementById('ev-title').value = day.recurring_event.label;
        document.getElementById('ev-time').value = day.recurring_event.default_start_time || '21:00';
        const dur = day.recurring_event.default_duration_minutes || 120;
        const durSel = document.getElementById('ev-duration');
        for (const opt of durSel.options) {
            if (parseInt(opt.value) === dur) { opt.selected = true; break; }
        }
    }
    updateFallback();
}

function nextOccurrenceOf(dayOfWeek) {
    const today = new Date();
    const todayDow = (today.getDay() + 6) % 7;
    let daysUntil = (dayOfWeek - todayDow + 7) % 7;
    if (daysUntil === 0) daysUntil = 7;
    const next = new Date(today);
    next.setDate(today.getDate() + daysUntil);
    return next.toISOString().split('T')[0];
}

// â”€â”€ Player status overrides â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function overrideStatus(playerId, value) {
    const tr = document.querySelector(`tr[data-player-id="${playerId}"]`);
    const statusCell = tr.querySelector('.status-cell');
    const defaultStatus = tr.dataset.defaultStatus;
    const effective = value || defaultStatus;

    if (value) {
        playerOverrides[String(playerId)] = value;
    } else {
        delete playerOverrides[String(playerId)];
    }

    const cls = `status-badge--${effective}`;
    statusCell.innerHTML = `<span class="status-badge ${cls}">${effective.charAt(0).toUpperCase() + effective.slice(1)}</span>`;
}

// â”€â”€ Create Event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function createEvent() {
    const status = document.getElementById('ev-status');
    status.textContent = 'Creatingâ€¦';
    status.className = 'status-msg';

    const body = {
        title: document.getElementById('ev-title').value,
        event_type: document.getElementById('ev-type').value,
        event_date: document.getElementById('ev-date').value,
        start_time: document.getElementById('ev-time').value,
        timezone: 'America/New_York',
        duration_minutes: parseInt(document.getElementById('ev-duration').value),
        channel_id: document.getElementById('ev-channel').value || null,
        description: document.getElementById('ev-desc').value,
        recurring_event_id: selectedRecurringEventId,
        player_overrides: playerOverrides,
    };

    if (!body.title || !body.event_date || !body.start_time) {
        status.textContent = 'âœ— Title, date, and time are required';
        status.className = 'status-msg err';
        return;
    }

    try {
        const resp = await fetch('/api/v1/admin/raid-events', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body),
        });
        const data = await resp.json();
        if (data.ok) {
            const url = data.data.event_url;
            status.innerHTML = url
                ? `âœ“ Event created! <a href="${url}" target="_blank" style="color:var(--color-accent)">View in Raid-Helper</a>`
                : `âœ“ Event created (id: ${data.data.raid_helper_event_id})`;
            status.className = 'status-msg ok';
        } else {
            status.textContent = 'âœ— ' + (data.error || 'Error');
            status.className = 'status-msg err';
        }
    } catch (e) {
        status.textContent = 'âœ— ' + e.message;
        status.className = 'status-msg err';
    }
}

// â”€â”€ Manual Fallback text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateFallback() {
    const title = document.getElementById('ev-title').value || '(No title)';
    const dateVal = document.getElementById('ev-date').value || '(date)';
    const timeVal = document.getElementById('ev-time').value || '21:00';
    const dur = document.getElementById('ev-duration').value || '120';
    const desc = document.getElementById('ev-desc').value || '';
    const durLabel = { '60': '1 hour', '90': '1.5 hours', '120': '2 hours', '150': '2.5 hours', '180': '3 hours' }[dur] || dur + ' min';
    const text = `**${title}**\nðŸ“… ${dateVal} at ${timeVal} EST (${durLabel})\n${desc ? '\n' + desc : ''}`.trim();
    document.getElementById('fallback-text').textContent = text;
}

// â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAvailability() {
    try {
        const resp = await fetch('/api/v1/admin/availability-by-day');
        const data = await resp.json();
        if (data.ok) renderGrid(data.data);
    } catch (e) {
        document.getElementById('day-grid').textContent = 'Failed to load availability data.';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const today = new Date();
    const iso = new Date(today.getTime() + 86400000).toISOString().split('T')[0];
    document.getElementById('ev-date').value = iso;
    loadAvailability();
    updateFallback();
});
</script>
{% endblock %}
