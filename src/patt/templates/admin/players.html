{% extends "base_admin.html" %}
{% block title %}Player Manager â€” Admin â€” Pull All The Things{% endblock %}
{% block nav_players %}active{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/players.css">
{% endblock %}

{% block content %}
<div class="admin-header">
    <h1 class="admin-title">Player Manager</h1>
    <p style="color:var(--color-text-muted);margin-top:0.25rem;font-size:0.9rem;">
        Drag <strong>Discord users</strong> onto Players to link them.
        Drag <strong>Characters</strong> onto Players to assign them.
        All saves are instant.
    </p>
</div>

<div id="pm-status" class="flash-bar" style="display:none;"></div>

{# â”€â”€ Identity Matching Panel â”€â”€ #}
<details class="pm-match-panel" id="match-panel">
    <summary class="pm-match-summary">
        <span class="pm-match-summary__title">Identity Matching</span>
        <span class="pm-match-summary__hint">Auto-link unlinked characters to players</span>
    </summary>
    <div class="pm-match-body">
        <div class="pm-match-controls">
            <div class="pm-match-field">
                <label class="pm-match-label" for="match-rank">Minimum Rank</label>
                <select class="form-control" id="match-rank" style="width:200px">
                    <option value="">All ranks</option>
                    {% for rank in guild_ranks %}
                        <option value="{{ rank.level }}">{{ rank.name }} (level {{ rank.level }}+)</option>
                    {% endfor %}
                </select>
            </div>
            <button class="btn btn-primary" id="match-run-btn" onclick="runMatching()">
                Run Matching
            </button>
        </div>
        <p class="pm-match-hint">
            Processes unlinked characters using name matching, guild note parsing, and fuzzy scoring.
            Officers+ is a good starting point â€” run it, review Player Manager, then run all ranks when satisfied.
        </p>
        <div id="match-result" style="display:none;" class="pm-match-result"></div>
    </div>
</details>

<div id="pm-drill-banner" class="pm-drill-banner" style="display:none;">
    <span class="pm-drill-label"></span>
    <button class="pm-drill-clear" onclick="clearDrill()">âœ• Clear filter</button>
</div>

<div class="pm-three-col">

    {# â”€â”€ Col 1: Discord Users â”€â”€ #}
    <div class="pm-pane">
        <div class="pm-pane__header">
            <span class="pm-pane__title">Discord</span>
            <span class="pm-count" id="discord-count"></span>
            <button class="btn btn-secondary btn-sm" id="discord-sync-btn"
                    onclick="runDiscordSync()" title="Re-sync Discord members from server">â†» Sync</button>
        </div>
        <div class="pm-pane__toolbar">
            <input type="search" id="discord-search" class="form-control"
                   placeholder="Filter by usernameâ€¦" style="font-size:0.85rem;">
            <label class="pm-filter-label">
                <input type="checkbox" id="discord-unlinked-only"> Unlinked only
            </label>
        </div>
        <div id="discord-list" class="pm-scroll-list"></div>
    </div>

    {# â”€â”€ Col 2: Players â”€â”€ #}
    <div class="pm-pane">
        <div class="pm-pane__header">
            <span class="pm-pane__title">Players</span>
            <span class="pm-count" id="player-count"></span>
            <button class="btn btn-primary btn-sm pm-new-player-btn" onclick="showNewPlayerForm()">+ New</button>
        </div>
        <div class="pm-pane__toolbar">
            <input type="search" id="player-search" class="form-control"
                   placeholder="Filter by nameâ€¦" style="font-size:0.85rem;">
            <div class="pm-filter-row">
                <details class="pm-rank-dropdown" id="rank-dropdown">
                    <summary class="pm-rank-summary" id="rank-summary">All Ranks â–¾</summary>
                    <div class="pm-rank-panel" id="rank-panel"></div>
                </details>
                <label class="pm-filter-label"><input type="checkbox" id="player-no-chars"> No chars</label>
                <label class="pm-filter-label"><input type="checkbox" id="player-no-discord"> No Discord</label>
                <label class="pm-filter-label"><input type="checkbox" id="player-no-main"> No main</label>
            </div>
        </div>
        <div id="new-player-form" style="display:none;" class="pm-new-form">
            <input id="new-player-name" class="form-control" placeholder="Display name (e.g. Trog)" style="font-size:0.85rem;">
            <div style="display:flex;gap:0.4rem;margin-top:0.4rem;">
                <button class="btn btn-primary btn-sm" onclick="createPlayer()">Create</button>
                <button class="btn btn-secondary btn-sm" onclick="hideNewPlayerForm()">Cancel</button>
            </div>
        </div>
        <div id="player-list" class="pm-scroll-list">
            <div class="pm-unassign-zone" id="pm-discord-unlink">
                <span>ðŸš« Drop Discord user here to unlink</span>
            </div>
        </div>
    </div>

    {# â”€â”€ Col 3: Characters â”€â”€ #}
    <div class="pm-pane">
        <div class="pm-pane__header">
            <span class="pm-pane__title">Characters</span>
            <span class="pm-count" id="char-count"></span>
            <button class="btn btn-secondary btn-sm" id="blizzard-sync-btn"
                    onclick="runBlizzardSync()" title="Re-sync guild roster from Blizzard API">â†» Sync</button>
        </div>
        <div class="pm-pane__toolbar">
            <input type="search" id="char-search" class="form-control"
                   placeholder="Name, class, specâ€¦" style="font-size:0.85rem;">
            <div class="pm-filter-row">
                <label class="pm-filter-label"><input type="checkbox" id="char-unlinked-only"> Unlinked only</label>
                <label class="pm-filter-label"><input type="checkbox" id="char-not-in-api"> Not in API</label>
                <label class="pm-filter-label"><input type="checkbox" id="char-role-mismatch"> Role mismatch</label>
            </div>
        </div>
        <div id="char-list" class="pm-scroll-list">
            <div class="pm-unassign-zone" id="pm-char-unlink">
                <span>ðŸš« Drop here to unlink character</span>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/players.js"></script>
<script>
async function runDiscordSync() {
    const btn = document.getElementById('discord-sync-btn');
    btn.disabled = true;
    btn.textContent = 'â†» Syncingâ€¦';
    try {
        const resp = await fetch('/api/guild-sync/discord/trigger', { method: 'POST' });
        const data = await resp.json();
        if (data.ok) {
            btn.textContent = 'âœ“ Done';
            setTimeout(() => { btn.disabled = false; btn.textContent = 'â†» Sync'; loadData(); }, 3000);
        } else {
            btn.textContent = 'âœ— Failed';
            setTimeout(() => { btn.disabled = false; btn.textContent = 'â†» Sync'; }, 3000);
        }
    } catch (e) {
        btn.textContent = 'âœ— Error';
        setTimeout(() => { btn.disabled = false; btn.textContent = 'â†» Sync'; }, 3000);
    }
}

async function runBlizzardSync() {
    const btn = document.getElementById('blizzard-sync-btn');
    btn.disabled = true;
    btn.textContent = 'â†» Syncingâ€¦';
    try {
        const resp = await fetch('/api/guild-sync/blizzard/trigger', { method: 'POST' });
        const data = await resp.json();
        if (data.ok) {
            btn.textContent = 'â†» Runningâ€¦';
            // Blizzard sync is async â€” poll for completion by reloading data after a delay
            setTimeout(() => { loadData(); }, 15000);
            setTimeout(() => { btn.disabled = false; btn.textContent = 'â†» Sync'; }, 20000);
        } else {
            btn.textContent = 'âœ— Failed';
            setTimeout(() => { btn.disabled = false; btn.textContent = 'â†» Sync'; }, 3000);
        }
    } catch (e) {
        btn.textContent = 'âœ— Error';
        setTimeout(() => { btn.disabled = false; btn.textContent = 'â†» Sync'; }, 3000);
    }
}

async function runMatching() {
    const btn = document.getElementById('match-run-btn');
    const result = document.getElementById('match-result');
    const rankVal = document.getElementById('match-rank').value;

    btn.disabled = true;
    btn.textContent = 'Runningâ€¦';
    result.style.display = 'none';

    const url = '/api/identity/run-matching' + (rankVal ? '?min_rank_level=' + rankVal : '');
    try {
        const resp = await fetch(url, { method: 'POST' });
        const data = await resp.json();
        if (data.ok) {
            result.className = 'pm-match-result pm-match-result--ok';
            const scope = rankVal ? 'Rank level ' + rankVal + '+' : 'All ranks';
            result.textContent = 'âœ“ Matching started (' + scope + '). Reload Player Manager in a moment to see the results.';
            result.style.display = 'block';
            // Reload the player data after a short delay
            setTimeout(() => { if (typeof loadData === 'function') loadData(); }, 2500);
        } else {
            result.className = 'pm-match-result pm-match-result--err';
            result.textContent = 'âœ— Error: ' + (data.detail || 'unknown error');
            result.style.display = 'block';
        }
    } catch (e) {
        result.className = 'pm-match-result pm-match-result--err';
        result.textContent = 'âœ— Network error: ' + e.message;
        result.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Run Matching';
    }
}
</script>
{% endblock %}
