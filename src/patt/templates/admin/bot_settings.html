{% extends "base_admin.html" %}
{% block title %}Bot Settings — Admin — Pull All The Things{% endblock %}
{% block nav_bot_settings %}active{% endblock %}

{% block head %}
<style>
.bs-card {
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    max-width: 640px;
}
.bs-card__title {
    font-family: 'Cinzel', serif;
    color: var(--color-gold);
    font-size: 1.1rem;
    margin: 0 0 0.25rem 0;
}
.bs-card__subtitle {
    color: var(--color-text-muted);
    font-size: 0.85rem;
    margin-bottom: 1.25rem;
}
.bs-toggle-row {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    margin-bottom: 1rem;
}
.bs-toggle-label {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
}
/* Toggle switch */
.bs-switch {
    position: relative;
    display: inline-block;
    width: 72px;
    height: 38px;
    flex-shrink: 0;
}
.bs-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.bs-slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #3a3a3e;
    border-radius: 38px;
    transition: background 0.3s;
    border: 2px solid #4a4a4e;
}
.bs-slider::before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background: #888;
    border-radius: 50%;
    transition: transform 0.3s, background 0.3s;
}
input:checked + .bs-slider {
    background: rgba(212, 168, 75, 0.25);
    border-color: var(--color-gold);
}
input:checked + .bs-slider::before {
    transform: translateX(34px);
    background: var(--color-gold);
}
.bs-toggle-status {
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
}
.bs-toggle-status--on  { color: var(--color-gold); }
.bs-toggle-status--off { color: #666; }

.bs-info {
    color: var(--color-text-muted);
    font-size: 0.875rem;
    line-height: 1.6;
    margin-bottom: 1rem;
}
.bs-divider {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 1rem 0;
}
.bs-stats {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 0.75rem;
    margin-top: 0.75rem;
}
.bs-stat {
    background: var(--color-bg-dark);
    border: 1px solid var(--color-border-subtle);
    border-radius: 6px;
    padding: 0.6rem 0.9rem;
    text-align: center;
}
.bs-stat__count {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text);
}
.bs-stat__label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-top: 0.2rem;
}
.bs-stat--alert .bs-stat__count { color: #fbbf24; }
.bs-saving {
    display: none;
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-left: 0.5rem;
}
.bs-features {
    margin-top: 1.25rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
}
.bs-features__title {
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--color-text-muted);
    margin-bottom: 0.75rem;
}
.bs-feature-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.6rem 0.75rem;
    border-radius: 6px;
    margin-bottom: 0.4rem;
    background: var(--color-bg-dark);
    border: 1px solid var(--color-border-subtle);
    transition: opacity 0.2s;
}
.bs-feature-row.bs-feature--disabled {
    opacity: 0.45;
    pointer-events: none;
}
/* Smaller toggle for feature rows */
.bs-switch--sm {
    width: 52px;
    height: 28px;
}
.bs-switch--sm .bs-slider {
    border-radius: 28px;
}
.bs-switch--sm .bs-slider::before {
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
}
.bs-switch--sm input:checked + .bs-slider::before {
    transform: translateX(24px);
}
.bs-feature-info {
    flex: 1;
}
.bs-feature-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text);
}
.bs-feature-desc {
    font-size: 0.78rem;
    color: var(--color-text-muted);
    margin-top: 0.1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="admin-page-header">
    <h1 class="admin-page-title">Bot Settings</h1>
    <p class="admin-page-subtitle">Control Discord bot messaging and onboarding behavior.</p>
</div>

{# Audit Channel Card #}
<div class="bs-card">
    <h2 class="bs-card__title">Audit Channel</h2>
    <p class="bs-card__subtitle">The channel where sync alerts and onboarding escalations are posted. Required for the guild sync scheduler to run.</p>

    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <select id="audit-channel-select" style="flex: 1; min-width: 220px; max-width: 380px;">
            <option value="">— loading channels —</option>
        </select>
        <button class="btn btn--secondary" id="audit-save-btn" onclick="saveAuditChannel()">Save</button>
        <span id="audit-save-status" style="font-size: 0.85rem; color: var(--color-text-muted);"></span>
    </div>
    <p class="bs-info" style="margin-top: 0.75rem;">
        If no channel is set, the background sync scheduler will not start after the next restart.
    </p>
</div>

{# Bot DM Toggle Card #}
<div class="bs-card">
    <h2 class="bs-card__title">Discord DM Messaging</h2>
    <p class="bs-card__subtitle">Controls all bot-initiated DMs: onboarding conversations, invite code delivery.</p>

    <div class="bs-toggle-row">
        <label class="bs-switch">
            <input type="checkbox" id="dm-toggle"
                   {% if discord_config and discord_config.bot_dm_enabled %}checked{% endif %}
                   onchange="toggleBotDm(this.checked)">
            <span class="bs-slider"></span>
        </label>
        <span class="bs-toggle-label">Enable Bot DMs</span>
        <span class="bs-toggle-status {% if discord_config and discord_config.bot_dm_enabled %}bs-toggle-status--on{% else %}bs-toggle-status--off{% endif %}"
              id="dm-status">
            {% if discord_config and discord_config.bot_dm_enabled %}ON{% else %}OFF{% endif %}
        </span>
        <span class="bs-saving" id="dm-saving">Saving…</span>
    </div>

    <p class="bs-info">
        Master switch. When <strong>OFF</strong>, no DMs are sent regardless of feature settings below.
        Discord sync, Blizzard sync, and slash commands all continue working.
    </p>

    {# Feature-level toggles #}
    <div class="bs-features" id="feature-panel">
        <div class="bs-features__title">Feature Controls</div>

        <div class="bs-feature-row {% if not discord_config or not discord_config.bot_dm_enabled %}bs-feature--disabled{% endif %}"
             id="feature-row-invite">
            <label class="bs-switch bs-switch--sm">
                <input type="checkbox" id="feature-invite-toggle"
                       {% if discord_config and discord_config.feature_invite_dm %}checked{% endif %}
                       onchange="toggleFeature('feature_invite_dm', this.checked)">
                <span class="bs-slider"></span>
            </label>
            <div class="bs-feature-info">
                <div class="bs-feature-name">Invite DMs</div>
                <div class="bs-feature-desc">Send registration invite codes to members via Discord DM (triggered manually from Roster).</div>
            </div>
            <span class="bs-toggle-status {% if discord_config and discord_config.feature_invite_dm %}bs-toggle-status--on{% else %}bs-toggle-status--off{% endif %}"
                  id="feature-invite-status">
                {% if discord_config and discord_config.feature_invite_dm %}ON{% else %}OFF{% endif %}
            </span>
        </div>

        <div class="bs-feature-row {% if not discord_config or not discord_config.bot_dm_enabled %}bs-feature--disabled{% endif %}"
             id="feature-row-onboarding">
            <label class="bs-switch bs-switch--sm">
                <input type="checkbox" id="feature-onboarding-toggle"
                       {% if discord_config and discord_config.feature_onboarding_dm %}checked{% endif %}
                       onchange="toggleFeature('feature_onboarding_dm', this.checked)">
                <span class="bs-slider"></span>
            </label>
            <div class="bs-feature-info">
                <div class="bs-feature-name">Onboarding DMs</div>
                <div class="bs-feature-desc">Start automated onboarding conversations when new members join the Discord server.</div>
            </div>
            <span class="bs-toggle-status {% if discord_config and discord_config.feature_onboarding_dm %}bs-toggle-status--on{% else %}bs-toggle-status--off{% endif %}"
                  id="feature-onboarding-status">
                {% if discord_config and discord_config.feature_onboarding_dm %}ON{% else %}OFF{% endif %}
            </span>
        </div>
    </div>
</div>

{# Onboarding Queue Card #}
<div class="bs-card">
    <h2 class="bs-card__title">Onboarding Queue</h2>
    <p class="bs-card__subtitle">Active sessions. The scheduler checks every 30 minutes, or process immediately below.</p>

    <div class="bs-stats" id="onboarding-stats">
        <div class="bs-stat">
            <div class="bs-stat__count">—</div>
            <div class="bs-stat__label">Loading…</div>
        </div>
    </div>

    <div style="margin-top: 1rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <button class="btn btn--secondary" id="process-queue-btn" onclick="processQueue()">
            Process Queue Now
        </button>
        <span id="process-result" style="font-size: 0.85rem; color: var(--color-text-muted);"></span>
    </div>
</div>

<script>
// ── Channel dropdown ───────────────────────────────────────────────────────

let _channelCache = null;

async function _fetchChannels() {
    if (_channelCache) return _channelCache;
    const resp = await fetch('/api/guild-sync/channels');
    const data = await resp.json();
    _channelCache = data.data || [];
    return _channelCache;
}

async function loadAuditChannelDropdown() {
    const sel = document.getElementById('audit-channel-select');
    const savedId = '{{ discord_config.audit_channel_id or "" }}';
    try {
        const channels = await _fetchChannels();
        const text_channels = channels.filter(ch =>
            ch.channel_type === 'text' || ch.channel_type === 'announcement');
        if (!text_channels.length) {
            sel.innerHTML = '<option value="">No channels synced — sync in Reference Tables</option>';
            return;
        }
        const byCategory = {};
        text_channels.forEach(ch => {
            const cat = ch.category_name || 'Uncategorized';
            (byCategory[cat] = byCategory[cat] || []).push(ch);
        });
        sel.innerHTML = '<option value="">— none —</option>' +
            Object.entries(byCategory).map(([cat, chs]) =>
                `<optgroup label="${cat}">${chs.map(ch =>
                    `<option value="${ch.discord_id}"${ch.discord_id === savedId ? ' selected' : ''}>#${ch.name}</option>`
                ).join('')}</optgroup>`
            ).join('');
    } catch (e) {
        sel.innerHTML = '<option value="">Failed to load channels</option>';
    }
}

async function saveAuditChannel() {
    const btn = document.getElementById('audit-save-btn');
    const status = document.getElementById('audit-save-status');
    const val = document.getElementById('audit-channel-select').value || null;
    btn.disabled = true;
    status.textContent = 'Saving…';
    try {
        const data = await patchSettings({audit_channel_id: val});
        if (data.ok) {
            status.style.color = 'var(--color-gold)';
            status.textContent = 'Saved';
        } else {
            status.style.color = '#f87171';
            status.textContent = data.error || 'Failed';
        }
    } catch (e) {
        status.style.color = '#f87171';
        status.textContent = 'Network error: ' + e.message;
    } finally {
        btn.disabled = false;
    }
}

// ── Bot DM toggles ─────────────────────────────────────────────────────────

async function patchSettings(payload) {
    const resp = await fetch('/api/v1/admin/bot-settings', {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
    });
    return resp.json();
}

async function toggleBotDm(enabled) {
    document.getElementById('dm-saving').style.display = 'inline';
    try {
        const data = await patchSettings({bot_dm_enabled: enabled});
        if (data.ok) {
            updateMasterUI(data.data.bot_dm_enabled);
        } else {
            document.getElementById('dm-toggle').checked = !enabled;
            alert('Failed to save: ' + (data.error || 'unknown error'));
        }
    } catch (e) {
        document.getElementById('dm-toggle').checked = !enabled;
        alert('Network error: ' + e.message);
    } finally {
        document.getElementById('dm-saving').style.display = 'none';
    }
}

async function toggleFeature(field, enabled) {
    try {
        const data = await patchSettings({[field]: enabled});
        if (data.ok) {
            updateFeatureUI(field, enabled);
        } else {
            // Revert checkbox
            const id = field === 'feature_invite_dm' ? 'feature-invite-toggle' : 'feature-onboarding-toggle';
            document.getElementById(id).checked = !enabled;
            alert('Failed to save: ' + (data.error || 'unknown error'));
        }
    } catch (e) {
        const id = field === 'feature_invite_dm' ? 'feature-invite-toggle' : 'feature-onboarding-toggle';
        document.getElementById(id).checked = !enabled;
        alert('Network error: ' + e.message);
    }
}

function updateMasterUI(enabled) {
    const status = document.getElementById('dm-status');
    status.textContent = enabled ? 'ON' : 'OFF';
    status.className = 'bs-toggle-status ' + (enabled ? 'bs-toggle-status--on' : 'bs-toggle-status--off');
    // Dim/undim feature rows
    document.querySelectorAll('.bs-feature-row').forEach(row => {
        row.classList.toggle('bs-feature--disabled', !enabled);
    });
}

function updateFeatureUI(field, enabled) {
    const isInvite = field === 'feature_invite_dm';
    const statusId = isInvite ? 'feature-invite-status' : 'feature-onboarding-status';
    const el = document.getElementById(statusId);
    el.textContent = enabled ? 'ON' : 'OFF';
    el.className = 'bs-toggle-status ' + (enabled ? 'bs-toggle-status--on' : 'bs-toggle-status--off');
}

async function loadOnboardingStats() {
    try {
        const resp = await fetch('/api/v1/admin/onboarding-stats');
        const data = await resp.json();
        if (!data.ok) return;

        const stats = data.data;
        const container = document.getElementById('onboarding-stats');

        const stateLabels = {
            'awaiting_dm': 'Awaiting DM',
            'asked_in_guild': 'In Conversation',
            'asked_main': 'In Conversation',
            'asked_alts': 'In Conversation',
            'pending_verification': 'Pending Verify',
            'verified': 'Verified',
        };

        // Aggregate "in conversation" states
        const aggregated = {};
        for (const [state, count] of Object.entries(stats)) {
            const label = stateLabels[state] || state;
            aggregated[label] = (aggregated[label] || 0) + count;
        }

        if (Object.keys(aggregated).length === 0) {
            container.innerHTML = '<p style="color: var(--color-text-muted); font-size: 0.875rem;">No pending sessions.</p>';
            return;
        }

        container.innerHTML = Object.entries(aggregated).map(([label, count]) => {
            const alertClass = label === 'Awaiting DM' ? ' bs-stat--alert' : '';
            return `<div class="bs-stat${alertClass}">
                <div class="bs-stat__count">${count}</div>
                <div class="bs-stat__label">${label}</div>
            </div>`;
        }).join('');
    } catch (e) {
        console.warn('Could not load onboarding stats', e);
    }
}

async function processQueue() {
    const btn = document.getElementById('process-queue-btn');
    const result = document.getElementById('process-result');
    btn.disabled = true;
    btn.textContent = 'Processing…';
    result.textContent = '';
    try {
        const resp = await fetch('/api/v1/admin/onboarding/process-queue', {method: 'POST'});
        const data = await resp.json();
        if (data.ok) {
            const s = data.data;
            result.style.color = 'var(--color-gold)';
            result.textContent = `Done — resumed: ${s.dm_resumed}, verified: ${s.verified}, provisioned: ${s.provisioned}, escalated: ${s.escalated}`;
            await loadOnboardingStats();
        } else {
            result.style.color = '#f87171';
            result.textContent = data.error || 'Failed';
        }
    } catch (e) {
        result.style.color = '#f87171';
        result.textContent = 'Network error: ' + e.message;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Process Queue Now';
    }
}

loadOnboardingStats();
loadAuditChannelDropdown();
</script>
{% endblock %}
