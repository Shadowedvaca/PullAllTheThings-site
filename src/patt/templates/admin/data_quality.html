{% extends "base_admin.html" %}
{% block title %}Data Quality â€” Admin â€” Pull All The Things{% endblock %}
{% block nav_data_quality %}active{% endblock %}

{% block head %}
<style>
/* ------------------------------------------------------------------ Page header */
.dq-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1.75rem;
    flex-wrap: wrap;
}
.dq-header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-shrink: 0;
}

/* ------------------------------------------------------------------ Coverage panel */
.coverage-panel {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.25rem 1.5rem;
    margin-bottom: 2rem;
}
.coverage-panel-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
    margin-bottom: 1rem;
}
.coverage-bars {
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
    margin-bottom: 1.25rem;
}
.coverage-bar-row {
    display: grid;
    grid-template-columns: 160px 1fr 70px;
    gap: 0.75rem;
    align-items: center;
}
.coverage-bar-label {
    font-size: 0.82rem;
    color: var(--color-text-muted);
    white-space: nowrap;
}
.coverage-bar-track {
    height: 8px;
    background: var(--color-bg-card);
    border-radius: 100px;
    overflow: hidden;
}
.coverage-bar-fill {
    height: 100%;
    border-radius: 100px;
    transition: width 0.4s ease;
}
.coverage-bar-fill--green  { background: var(--color-success); }
.coverage-bar-fill--amber  { background: var(--color-warning); }
.coverage-bar-fill--red    { background: var(--color-danger); }
.coverage-bar-pct {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--color-text);
    text-align: right;
    white-space: nowrap;
}

.coverage-breakdowns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}
.coverage-breakdown {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
}
.coverage-breakdown-title {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
}
.coverage-breakdown-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: var(--color-text-muted);
    padding: 0.1rem 0;
}
.coverage-breakdown-key {
    font-family: var(--font-mono);
    color: var(--color-text-muted);
}
.coverage-breakdown-val {
    font-weight: 600;
    color: var(--color-text);
}

.coverage-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

/* ------------------------------------------------------------------ Matching results */
.matching-result-block {
    margin-top: 1rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 0.85rem 1rem;
    font-size: 0.82rem;
}
.matching-result-header {
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 0.6rem;
}
.badge-converged {
    display: inline-block;
    background: rgba(74,222,128,0.12);
    color: var(--color-success);
    border: 1px solid rgba(74,222,128,0.3);
    border-radius: 100px;
    padding: 0.05rem 0.5rem;
    font-size: 0.72rem;
    font-weight: 600;
}
.badge-warn {
    display: inline-block;
    background: rgba(251,191,36,0.12);
    color: var(--color-warning);
    border: 1px solid rgba(251,191,36,0.3);
    border-radius: 100px;
    padding: 0.05rem 0.5rem;
    font-size: 0.72rem;
    font-weight: 600;
}
.matching-pass-block {
    margin-top: 0.5rem;
}
.matching-pass-label {
    font-weight: 700;
    color: var(--color-text-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
}
.matching-rule-list {
    margin-top: 0.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
}
.matching-rule-row {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    background: rgba(255,255,255,0.03);
}
.rule-name {
    font-family: var(--font-mono);
    font-size: 0.78rem;
    color: var(--color-accent);
    min-width: 100px;
}
.rule-stat {
    font-size: 0.78rem;
    color: var(--color-text);
}
.rule-discord { color: var(--color-success); }
.rule-stub    { color: var(--color-text-muted); }
.rule-nothing { font-size: 0.78rem; color: var(--color-text-muted); font-style: italic; }
.rule-no-change { opacity: 0.6; }
.matching-totals {
    margin-top: 0.65rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--color-border);
    color: var(--color-text);
    font-weight: 600;
    font-size: 0.82rem;
}

.coverage-loading {
    color: var(--color-text-muted);
    font-size: 0.85rem;
    padding: 0.5rem 0;
}
.coverage-error {
    color: var(--color-danger);
    font-size: 0.85rem;
    padding: 0.5rem 0;
}

/* ------------------------------------------------------------------ Unmatched tables */
.unmatched-section {
    margin-bottom: 2rem;
}
.unmatched-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}
.unmatched-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
}
.unmatched-count {
    font-size: 0.75rem;
    font-weight: 700;
    padding: 0.12rem 0.5rem;
    border-radius: 100px;
    background: rgba(251,191,36,0.12);
    color: var(--color-warning);
    border: 1px solid rgba(251,191,36,0.4);
}

/* ------------------------------------------------------------------ Rule cards */
.dq-rules {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 2rem;
}

.dq-rule-card {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1rem 1.25rem;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.5rem 1.5rem;
    align-items: start;
}
.dq-rule-card:hover {
    border-color: var(--color-border-light);
}

.dq-rule-top {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    flex-wrap: wrap;
}
.dq-rule-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--color-text);
}
.dq-rule-type {
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--color-text-muted);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 0.1rem 0.4rem;
}
.dq-rule-badge {
    font-size: 0.7rem;
    font-weight: 700;
    padding: 0.15rem 0.5rem;
    border-radius: 100px;
    white-space: nowrap;
}
.dq-rule-badge--auto {
    background: rgba(74,222,128,0.12);
    color: var(--color-success);
    border: 1px solid var(--color-success);
}
.dq-rule-badge--manual {
    background: rgba(251,191,36,0.10);
    color: var(--color-warning);
    border: 1px solid rgba(251,191,36,0.4);
}

.dq-rule-desc {
    font-size: 0.82rem;
    color: var(--color-text-muted);
    margin-top: 0.2rem;
    grid-column: 1;
}
.dq-rule-stats {
    display: flex;
    gap: 1.25rem;
    margin-top: 0.35rem;
    grid-column: 1;
    flex-wrap: wrap;
}
.dq-stat {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}
.dq-stat__value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--color-text);
    line-height: 1.2;
}
.dq-stat__value--open {
    color: var(--color-warning);
}
.dq-stat__value--zero {
    color: var(--color-text-muted);
}
.dq-stat__label {
    font-size: 0.7rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
.dq-rule-last {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
    grid-column: 1;
}

.dq-rule-actions {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    grid-row: 1 / span 4;
    grid-column: 2;
    align-items: flex-end;
    padding-top: 0.1rem;
}

/* ------------------------------------------------------------------ Severity badge */
.sev {
    display: inline-block;
    padding: 0.12rem 0.5rem;
    border-radius: 100px;
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    white-space: nowrap;
}
.sev-warning { background: rgba(251,191,36,0.15); color: var(--color-warning); border: 1px solid var(--color-warning); }
.sev-error   { background: rgba(248,113,113,0.15); color: var(--color-danger);  border: 1px solid var(--color-danger); }
.sev-info    { background: rgba(96,165,250,0.12);  color: var(--color-info);    border: 1px solid var(--color-info); }

/* ------------------------------------------------------------------ Recent findings */
.dq-findings-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
    gap: 0.5rem;
}
.dq-findings-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
}
.dq-findings-subtitle {
    font-size: 0.8rem;
    color: var(--color-text-muted);
}

.issue-type-chip {
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--color-text-muted);
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 0.1rem 0.4rem;
    white-space: nowrap;
}
.td-summary { max-width: 340px; }
.td-entity  { font-size: 0.8rem; color: var(--color-text-muted); white-space: nowrap; }
.td-age     { font-size: 0.78rem; color: var(--color-text-muted); white-space: nowrap; }
.td-status  { font-size: 0.78rem; white-space: nowrap; }

.resolved-label {
    color: var(--color-success);
    font-size: 0.75rem;
}
.open-label {
    color: var(--color-warning);
    font-size: 0.75rem;
}

/* ------------------------------------------------------------------ Known aliases */
.alias-registry {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 0.75rem 1.25rem;
}
.alias-registry-summary {
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    user-select: none;
    list-style: none;
}
.alias-registry-summary::-webkit-details-marker { display: none; }
.alias-registry-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
}
.alias-registry-meta {
    font-size: 0.8rem;
    color: var(--color-text-muted);
}
.alias-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    align-items: center;
}
.alias-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: 100px;
    padding: 0.15rem 0.5rem 0.15rem 0.6rem;
    font-size: 0.78rem;
    font-family: var(--font-mono);
    color: var(--color-text-muted);
}
.alias-chip-del {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--color-text-muted);
    font-size: 0.9rem;
    line-height: 1;
    padding: 0 0.1rem;
    opacity: 0.6;
}
.alias-chip-del:hover { opacity: 1; color: var(--color-danger); }
.alias-add-input {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text);
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    width: 120px;
    outline: none;
}
.alias-add-input:focus { border-color: var(--color-gold); }

.no-pool-notice {
    background: rgba(251,191,36,0.08);
    border: 1px solid rgba(251,191,36,0.3);
    border-radius: var(--radius);
    padding: 1rem 1.25rem;
    color: var(--color-warning);
    font-size: 0.875rem;
}

/* ------------------------------------------------------------------ Action feedback */
.dq-action-feedback {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    background: var(--color-bg-panel);
    border: 1px solid var(--color-success);
    border-radius: var(--radius);
    padding: 0.6rem 1rem;
    color: var(--color-success);
    font-size: 0.875rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.2s, transform 0.2s;
    pointer-events: none;
    z-index: 100;
}
.dq-action-feedback.visible {
    opacity: 1;
    transform: translateY(0);
}

/* ------------------------------------------------------------------ Section divider */
.section-divider {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 2rem 0;
}
.section-heading {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="dq-header">
    <div>
        <h1 class="admin-title">Data Quality</h1>
        <p class="text-muted text-sm" style="margin-top:0.25rem">
            Matching coverage and rules-based detection for guild identity issues.
        </p>
    </div>
    {% if pool_available %}
    <div class="dq-header-actions">
        <button class="btn btn-secondary btn-sm" onclick="runScanAll(this)">
            Run Full Scan
        </button>
        <a href="/admin/audit-log" class="btn btn-secondary btn-sm">
            Audit Log â†’
        </a>
    </div>
    {% endif %}
</div>

{% if not pool_available %}
<div class="no-pool-notice">
    Guild sync pool not available â€” configure BLIZZARD_CLIENT_ID/SECRET and restart the app
    to enable data quality operations.
</div>
{% else %}

{# ------------------------------------------------------------------ Coverage panel #}
<div class="coverage-panel">
    <div class="coverage-panel-title">Matching Coverage</div>
    <div id="coverage-loading" class="coverage-loading">Loading coverage statsâ€¦</div>
    <div id="coverage-content" style="display:none">
        <div class="coverage-bars" id="coverage-bars"></div>
        <div class="coverage-breakdowns" id="coverage-breakdowns"></div>
        <div class="coverage-actions">
            <button class="btn btn-secondary btn-sm" onclick="runMatchingNow(this)">
                Run Matching
            </button>
            <button class="btn btn-secondary btn-sm" onclick="loadCoverage()">
                Refresh Stats
            </button>
        </div>
        <div id="matching-results" style="display:none"></div>
    </div>
    <div id="coverage-error" class="coverage-error" style="display:none"></div>
</div>

{# ------------------------------------------------------------------ Unmatched tables (populated by JS) #}
<div id="unmatched-section" style="display:none">
    <div id="unmatched-chars-section" class="unmatched-section" style="display:none">
        <div class="unmatched-header">
            <span class="unmatched-title">Unmatched Characters</span>
            <span class="unmatched-count" id="unmatched-chars-count">0</span>
        </div>
        <div class="table-wrapper">
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Rank</th>
                        <th>Guild Note</th>
                        <th>Last Login</th>
                    </tr>
                </thead>
                <tbody id="unmatched-chars-body"></tbody>
            </table>
        </div>
    </div>

    <div id="unmatched-discord-section" class="unmatched-section" style="display:none">
        <div class="unmatched-header">
            <span class="unmatched-title">Unmatched Discord Users</span>
            <span class="unmatched-count" id="unmatched-discord-count">0</span>
        </div>
        <div class="table-wrapper">
            <table class="table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Display Name</th>
                        <th>Role</th>
                        <th>Joined</th>
                    </tr>
                </thead>
                <tbody id="unmatched-discord-body"></tbody>
            </table>
        </div>
    </div>
</div>

<hr class="section-divider">
<div class="section-heading">Audit Rules</div>

{# ------------------------------------------------------------------ Rules panel #}
{% if rules_with_stats %}
<div class="dq-rules">
    {% for entry in rules_with_stats %}
    {% set rule = entry.rule %}
    <div class="dq-rule-card" id="rule-{{ rule.issue_type }}">

        <div class="dq-rule-top">
            <span class="dq-rule-name">{{ rule.name }}</span>
            <span class="dq-rule-type">{{ rule.issue_type }}</span>
            <span class="sev sev-{{ rule.severity }}">{{ rule.severity }}</span>
            {% if rule.auto_mitigate %}
                <span class="dq-rule-badge dq-rule-badge--auto">âš¡ Auto-fix</span>
            {% else %}
                <span class="dq-rule-badge dq-rule-badge--manual">ðŸ‘¤ Manual</span>
            {% endif %}
        </div>

        <div class="dq-rule-desc">{{ rule.description }}</div>

        <div class="dq-rule-stats">
            <div class="dq-stat">
                <span class="dq-stat__value {% if entry.open_count > 0 %}dq-stat__value--open{% else %}dq-stat__value--zero{% endif %}">
                    {{ entry.open_count }}
                </span>
                <span class="dq-stat__label">Open</span>
            </div>
            <div class="dq-stat">
                <span class="dq-stat__value {% if entry.resolved_30d == 0 %}dq-stat__value--zero{% endif %}">
                    {{ entry.resolved_30d }}
                </span>
                <span class="dq-stat__label">Resolved (30d)</span>
            </div>
        </div>

        {% if entry.last_triggered %}
        <div class="dq-rule-last">
            Last detected: {{ entry.last_triggered.strftime('%Y-%m-%d %H:%M UTC') }}
        </div>
        {% else %}
        <div class="dq-rule-last text-muted">Never detected</div>
        {% endif %}

        <div class="dq-rule-actions">
            <button class="btn btn-secondary btn-sm"
                    onclick="runScan('{{ rule.issue_type }}', this)"
                    title="Run detection for this rule now">
                Scan
            </button>
            {% if rule.mitigate_fn is not none and entry.open_count > 0 %}
            <button class="btn btn-primary btn-sm"
                    onclick="runFixAll('{{ rule.issue_type }}', this)"
                    title="Attempt to fix all open {{ rule.issue_type }} issues">
                Fix All ({{ entry.open_count }})
            </button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<hr class="section-divider">
<div class="section-heading">Recent Findings</div>

{# ------------------------------------------------------------------ Recent findings #}
<div class="dq-findings-header">
    <div>
        <span class="dq-findings-subtitle">last 50 issues</span>
    </div>
</div>

{% if recent_issues %}
<div class="table-wrapper">
    <table class="table">
        <thead>
            <tr>
                <th>Severity</th>
                <th>Type</th>
                <th>Summary</th>
                <th>Entity</th>
                <th>Age</th>
                <th>Status</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for issue in recent_issues %}
            <tr id="issue-row-{{ issue.id }}">
                <td>
                    <span class="sev sev-{{ issue.severity }}">{{ issue.severity }}</span>
                </td>
                <td>
                    <span class="issue-type-chip">{{ issue.issue_type }}</span>
                </td>
                <td class="td-summary">{{ issue.summary }}</td>
                <td class="td-entity">
                    {% if issue.character_name %}
                        WoW: <strong>{{ issue.character_name }}</strong>
                    {% elif issue.discord_display_name or issue.discord_username %}
                        Discord: <strong>{{ issue.discord_display_name or issue.discord_username }}</strong>
                    {% else %}
                        â€”
                    {% endif %}
                </td>
                <td class="td-age">
                    {{ issue.created_at.strftime('%Y-%m-%d') }}<br>
                    <span class="text-xs">{{ issue.created_at.strftime('%H:%M UTC') }}</span>
                </td>
                <td class="td-status">
                    {% if issue.resolved_at %}
                        <span class="resolved-label">âœ“ Resolved</span><br>
                        <span class="text-xs text-muted">{{ issue.resolved_by or 'auto' }}</span>
                    {% else %}
                        <span class="open-label">Open</span>
                    {% endif %}
                </td>
                <td>
                    {% if not issue.resolved_at %}
                    {% set rule = none %}
                    {% for entry in rules_with_stats %}
                        {% if entry.rule.issue_type == issue.issue_type and entry.rule.mitigate_fn is not none %}
                            {% set rule = entry.rule %}
                        {% endif %}
                    {% endfor %}
                    {% if rule %}
                    <button class="btn btn-secondary btn-sm"
                            onclick="runFix({{ issue.id }}, this)"
                            title="Attempt fix for this issue">
                        Fix
                    </button>
                    {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div style="text-align:center; padding:2rem 1rem; color:var(--color-text-muted)">
    No issues recorded yet â€” run a scan to detect problems.
</div>
{% endif %}

{# ------------------------------------------------------------------ Known Note Aliases #}
{% if alias_registry %}
<details class="alias-registry" style="margin-top:2rem">
    <summary class="alias-registry-summary">
        <span class="alias-registry-title">Known Note Aliases</span>
        <span class="alias-registry-meta">
            {{ alias_registry | length }} player(s),
            {{ alias_total_count }} alias(es) tracked
        </span>
    </summary>
    <div class="table-wrapper" style="margin-top:0.75rem">
        <table class="table">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Discord</th>
                    <th>Aliases</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for entry in alias_registry %}
                <tr id="alias-player-{{ entry.player_id }}">
                    <td>{{ entry.display_name }}</td>
                    <td class="td-entity">{{ entry.discord_username or 'â€”' }}</td>
                    <td>
                        <div class="alias-chips" id="alias-chips-{{ entry.player_id }}">
                            {% for a in entry.aliases %}
                            <span class="alias-chip" id="alias-chip-{{ a.id }}">
                                <span class="alias-chip-text" title="source: {{ a.source }}">{{ a.alias }}</span>
                                <button class="alias-chip-del"
                                        onclick="deleteAlias({{ a.id }}, this)"
                                        title="Remove alias">Ã—</button>
                            </span>
                            {% endfor %}
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-secondary btn-sm alias-add-btn"
                                onclick="showAddAlias({{ entry.player_id }}, this)"
                                title="Add alias for this player">+</button>
                        <span class="alias-add-form" id="alias-add-{{ entry.player_id }}" style="display:none">
                            <input type="text" class="alias-add-input"
                                   id="alias-input-{{ entry.player_id }}"
                                   placeholder="aliasâ€¦" maxlength="50">
                            <button class="btn btn-primary btn-sm"
                                    onclick="addAlias({{ entry.player_id }}, this)">Add</button>
                            <button class="btn btn-secondary btn-sm"
                                    onclick="cancelAddAlias({{ entry.player_id }})">âœ•</button>
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</details>
{% endif %}

{% endif %}{# /pool_available #}

{# Action feedback toast #}
<div class="dq-action-feedback" id="dq-toast"></div>

{% endblock %}

{% block scripts %}
<script>
function showToast(msg, isError) {
    const el = document.getElementById('dq-toast');
    el.textContent = msg;
    el.style.borderColor = isError ? 'var(--color-danger)' : 'var(--color-success)';
    el.style.color = isError ? 'var(--color-danger)' : 'var(--color-success)';
    el.classList.add('visible');
    setTimeout(() => el.classList.remove('visible'), 3000);
}

// --------------------------------------------------------------------------
// Coverage dashboard
// --------------------------------------------------------------------------

function coverageColor(pct) {
    if (pct >= 80) return 'green';
    if (pct >= 50) return 'amber';
    return 'red';
}

function renderBar(label, matched, total, pct) {
    const cls = coverageColor(pct);
    return `<div class="coverage-bar-row">
        <span class="coverage-bar-label">${label}</span>
        <div class="coverage-bar-track">
            <div class="coverage-bar-fill coverage-bar-fill--${cls}" style="width:${pct}%"></div>
        </div>
        <span class="coverage-bar-pct">${matched}/${total} (${pct}%)</span>
    </div>`;
}

function renderBreakdown(title, data) {
    const rows = Object.entries(data)
        .sort((a, b) => b[1] - a[1])
        .map(([k, v]) => `<div class="coverage-breakdown-row">
            <span class="coverage-breakdown-key">${k}</span>
            <span class="coverage-breakdown-val">${v}</span>
        </div>`)
        .join('');
    return `<div class="coverage-breakdown">
        <div class="coverage-breakdown-title">${title}</div>
        ${rows || '<div class="coverage-breakdown-row" style="color:var(--color-text-muted)">No data yet</div>'}
    </div>`;
}

function renderUnmatchedChars(chars) {
    const section = document.getElementById('unmatched-chars-section');
    const body = document.getElementById('unmatched-chars-body');
    const count = document.getElementById('unmatched-chars-count');
    if (!chars || chars.length === 0) {
        section.style.display = 'none';
        return;
    }
    count.textContent = chars.length;
    body.innerHTML = chars.map(c => {
        const login = c.last_login_days_ago !== null
            ? (c.last_login_days_ago === 0 ? 'Today' : `${c.last_login_days_ago}d ago`)
            : 'â€”';
        const note = c.guild_note || '<span style="color:var(--color-text-muted)">â€”</span>';
        const rank = c.guild_rank || '<span style="color:var(--color-text-muted)">â€”</span>';
        return `<tr>
            <td><strong>${c.character_name}</strong> <span style="font-size:0.75rem;color:var(--color-text-muted)">${c.realm}</span></td>
            <td>${rank}</td>
            <td style="font-family:var(--font-mono);font-size:0.8rem">${note}</td>
            <td style="font-size:0.78rem;color:var(--color-text-muted)">${login}</td>
        </tr>`;
    }).join('');
    section.style.display = '';
}

function renderUnmatchedDiscord(users) {
    const section = document.getElementById('unmatched-discord-section');
    const body = document.getElementById('unmatched-discord-body');
    const count = document.getElementById('unmatched-discord-count');
    if (!users || users.length === 0) {
        section.style.display = 'none';
        return;
    }
    count.textContent = users.length;
    body.innerHTML = users.map(u => {
        const joined = u.joined_server_at
            ? new Date(u.joined_server_at).toLocaleDateString('en-US', {month:'short', year:'numeric'})
            : 'â€”';
        return `<tr>
            <td style="font-family:var(--font-mono);font-size:0.85rem">${u.username}</td>
            <td>${u.display_name || '<span style="color:var(--color-text-muted)">â€”</span>'}</td>
            <td style="font-size:0.8rem;color:var(--color-text-muted)">${u.highest_guild_role || 'â€”'}</td>
            <td style="font-size:0.78rem;color:var(--color-text-muted)">${joined}</td>
        </tr>`;
    }).join('');
    section.style.display = '';
}

async function loadCoverage() {
    const loading = document.getElementById('coverage-loading');
    const content = document.getElementById('coverage-content');
    const errorEl = document.getElementById('coverage-error');
    const unmatchedSection = document.getElementById('unmatched-section');

    loading.style.display = '';
    content.style.display = 'none';
    errorEl.style.display = 'none';

    try {
        const r = await fetch('/admin/matching/coverage');
        const d = await r.json();
        if (!d.ok) {
            errorEl.textContent = 'Error: ' + (d.error || 'Unknown error');
            errorEl.style.display = '';
            loading.style.display = 'none';
            return;
        }

        const s = d.data.summary;
        const barsEl = document.getElementById('coverage-bars');
        barsEl.innerHTML =
            renderBar('Characters', s.matched_characters, s.total_characters, s.character_coverage_pct) +
            renderBar('Discord Users', s.matched_discord_users, s.total_discord_users, s.discord_coverage_pct) +
            renderBar('Players w/ Discord', s.players_with_discord, s.total_players, s.discord_link_pct);

        const breakdownsEl = document.getElementById('coverage-breakdowns');
        breakdownsEl.innerHTML =
            renderBreakdown('By Link Source', d.data.by_link_source) +
            renderBreakdown('By Confidence', d.data.by_confidence);

        loading.style.display = 'none';
        content.style.display = '';

        renderUnmatchedChars(d.data.unmatched_characters);
        renderUnmatchedDiscord(d.data.unmatched_discord_users);
        const hasUnmatched = (d.data.unmatched_characters && d.data.unmatched_characters.length > 0) ||
                             (d.data.unmatched_discord_users && d.data.unmatched_discord_users.length > 0);
        unmatchedSection.style.display = hasUnmatched ? '' : 'none';

    } catch(e) {
        errorEl.textContent = 'Failed to load coverage stats.';
        errorEl.style.display = '';
        loading.style.display = 'none';
    }
}

async function runMatchingNow(btn) {
    btn.disabled = true;
    btn.textContent = 'Runningâ€¦';
    const resultsEl = document.getElementById('matching-results');
    resultsEl.style.display = 'none';
    resultsEl.innerHTML = '';
    try {
        const r = await fetch('/api/guild-sync/matching/trigger', { method: 'POST' });
        const d = await r.json();
        if (d.ok) {
            renderMatchingResults(d.data, resultsEl);
            await loadCoverage();
        } else {
            showToast('Error: ' + (d.error || 'Unknown error'), true);
        }
    } catch(e) {
        showToast('Request failed', true);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Run Matching';
    }
}

function renderMatchingResults(data, el) {
    const passes = {};
    for (const r of (data.results || [])) {
        if (!passes[r.pass]) passes[r.pass] = [];
        passes[r.pass].push(r);
    }

    const converged = data.converged;
    const passCount = data.passes || 0;
    const totals = data.totals || {};

    let html = '<div class="matching-result-block">';
    html += `<div class="matching-result-header">`;
    html += `Matching complete â€” ${passCount} pass${passCount !== 1 ? 'es' : ''}`;
    html += converged
        ? ' <span class="badge-converged">converged âœ“</span>'
        : ' <span class="badge-warn">hit max passes</span>';
    html += '</div>';

    for (const [passNum, rules] of Object.entries(passes)) {
        html += `<div class="matching-pass-block">`;
        html += `<span class="matching-pass-label">Pass ${passNum}</span>`;
        html += `<div class="matching-rule-list">`;
        for (const r of rules) {
            const changed = r.players_created > 0 || r.chars_linked > 0;
            if (changed) {
                html += `<div class="matching-rule-row">`;
                html += `<span class="rule-name">${r.rule}</span>`;
                html += `<span class="rule-stat">${r.players_created} player${r.players_created !== 1 ? 's' : ''} created</span>`;
                html += `<span class="rule-stat">${r.chars_linked} char${r.chars_linked !== 1 ? 's' : ''} linked</span>`;
                if (r.discord_linked > 0) {
                    html += `<span class="rule-stat rule-discord">${r.discord_linked} with Discord</span>`;
                }
                if (r.stubs_created > 0) {
                    html += `<span class="rule-stat rule-stub">${r.stubs_created} stub${r.stubs_created !== 1 ? 's' : ''}</span>`;
                }
                html += '</div>';
            } else {
                html += `<div class="matching-rule-row rule-no-change">`;
                html += `<span class="rule-name">${r.rule}</span>`;
                html += `<span class="rule-nothing">nothing new</span>`;
                html += '</div>';
            }
        }
        html += '</div></div>';
    }

    if (totals.players_created > 0 || totals.chars_linked > 0) {
        html += `<div class="matching-totals">`;
        html += `Totals: ${totals.players_created} player${totals.players_created !== 1 ? 's' : ''} created, `;
        html += `${totals.chars_linked} char${totals.chars_linked !== 1 ? 's' : ''} linked`;
        if (totals.no_discord_match > 0) {
            html += `, ${totals.no_discord_match} stub${totals.no_discord_match !== 1 ? 's' : ''}`;
        }
        html += '</div>';
    } else {
        html += '<div class="matching-totals">Nothing new to link â€” all characters already matched.</div>';
    }

    html += '</div>';
    el.innerHTML = html;
    el.style.display = '';
}

document.addEventListener('DOMContentLoaded', loadCoverage);

// --------------------------------------------------------------------------
// Existing rule / fix / alias functions
// --------------------------------------------------------------------------

async function runScanAll(btn) {
    btn.disabled = true;
    btn.textContent = 'Scanningâ€¦';
    try {
        const r = await fetch('/admin/data-quality/scan', { method: 'POST' });
        const d = await r.json();
        if (d.ok) {
            showToast('Scan started â€” reload page in a moment to see results.');
        } else {
            showToast('Error: ' + d.error, true);
        }
    } catch(e) {
        showToast('Request failed', true);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Run Full Scan';
    }
}

async function runScan(issueType, btn) {
    btn.disabled = true;
    const orig = btn.textContent;
    btn.textContent = 'Scanningâ€¦';
    try {
        const r = await fetch('/admin/data-quality/scan/' + issueType, { method: 'POST' });
        const d = await r.json();
        if (d.ok) {
            showToast('Scan for ' + issueType + ' started.');
        } else {
            showToast('Error: ' + d.error, true);
        }
    } catch(e) {
        showToast('Request failed', true);
    } finally {
        btn.disabled = false;
        btn.textContent = orig;
    }
}

async function runFix(issueId, btn) {
    btn.disabled = true;
    btn.textContent = 'Fixingâ€¦';
    try {
        const r = await fetch('/admin/data-quality/fix/' + issueId, { method: 'POST' });
        const d = await r.json();
        if (d.ok) {
            showToast('Fix started for issue #' + issueId + ' â€” reload to check result.');
        } else {
            showToast('Error: ' + d.error, true);
            btn.disabled = false;
            btn.textContent = 'Fix';
        }
    } catch(e) {
        showToast('Request failed', true);
        btn.disabled = false;
        btn.textContent = 'Fix';
    }
}

async function deleteAlias(aliasId, btn) {
    if (!confirm('Remove this alias?')) return;
    btn.disabled = true;
    try {
        const r = await fetch('/admin/data-quality/aliases/' + aliasId, { method: 'DELETE' });
        const d = await r.json();
        if (d.ok) {
            const chip = document.getElementById('alias-chip-' + aliasId);
            if (chip) chip.remove();
            showToast('Alias removed.');
        } else {
            showToast('Error: ' + d.error, true);
            btn.disabled = false;
        }
    } catch(e) {
        showToast('Request failed', true);
        btn.disabled = false;
    }
}

function showAddAlias(playerId, btn) {
    btn.style.display = 'none';
    const form = document.getElementById('alias-add-' + playerId);
    form.style.display = 'inline-flex';
    form.style.gap = '0.3rem';
    form.style.alignItems = 'center';
    document.getElementById('alias-input-' + playerId).focus();
}

function cancelAddAlias(playerId) {
    document.getElementById('alias-add-' + playerId).style.display = 'none';
    const row = document.getElementById('alias-player-' + playerId);
    if (row) {
        const addBtn = row.querySelector('.alias-add-btn');
        if (addBtn) addBtn.style.display = '';
    }
}

async function addAlias(playerId, btn) {
    const input = document.getElementById('alias-input-' + playerId);
    const alias = input.value.trim().toLowerCase();
    if (!alias) return;
    btn.disabled = true;
    try {
        const r = await fetch('/admin/data-quality/aliases', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ player_id: playerId, alias }),
        });
        const d = await r.json();
        if (d.ok) {
            const chips = document.getElementById('alias-chips-' + playerId);
            const chip = document.createElement('span');
            chip.className = 'alias-chip';
            chip.id = 'alias-chip-' + d.alias.id;
            chip.innerHTML = `<span class="alias-chip-text" title="source: ${d.alias.source}">${d.alias.alias}</span>`
                + `<button class="alias-chip-del" onclick="deleteAlias(${d.alias.id}, this)" title="Remove alias">Ã—</button>`;
            chips.appendChild(chip);
            input.value = '';
            cancelAddAlias(playerId);
            showToast('Alias added.');
        } else {
            showToast('Error: ' + d.error, true);
        }
    } catch(e) {
        showToast('Request failed', true);
    } finally {
        btn.disabled = false;
    }
}

async function runFixAll(issueType, btn) {
    btn.disabled = true;
    const orig = btn.textContent;
    btn.textContent = 'Runningâ€¦';
    try {
        const r = await fetch('/admin/data-quality/fix-all/' + issueType, { method: 'POST' });
        const d = await r.json();
        if (d.ok) {
            showToast('Fix-all for ' + issueType + ' started â€” reload in a moment.');
        } else {
            showToast('Error: ' + d.error, true);
            btn.disabled = false;
            btn.textContent = orig;
        }
    } catch(e) {
        showToast('Request failed', true);
        btn.disabled = false;
        btn.textContent = orig;
    }
}
</script>
{% endblock %}
