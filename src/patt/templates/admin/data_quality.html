{% extends "base_admin.html" %}
{% block title %}Data Quality â€” Admin â€” Pull All The Things{% endblock %}
{% block nav_data_quality %}active{% endblock %}

{% block head %}
<style>
/* ------------------------------------------------------------------ Page header */
.dq-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1.75rem;
    flex-wrap: wrap;
}
.dq-header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-shrink: 0;
}

/* ------------------------------------------------------------------ Coverage panel */
.coverage-panel {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.25rem 1.5rem;
    margin-bottom: 2rem;
}
.coverage-panel-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
    margin-bottom: 1rem;
}
.coverage-bars {
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
    margin-bottom: 1.25rem;
}
.coverage-bar-row {
    display: grid;
    grid-template-columns: 160px 1fr 70px;
    gap: 0.75rem;
    align-items: center;
}
.coverage-bar-label {
    font-size: 0.82rem;
    color: var(--color-text-muted);
    white-space: nowrap;
}
.coverage-bar-track {
    height: 8px;
    background: var(--color-bg-card);
    border-radius: 100px;
    overflow: hidden;
}
.coverage-bar-fill {
    height: 100%;
    border-radius: 100px;
    transition: width 0.4s ease;
}
.coverage-bar-fill--green  { background: var(--color-success); }
.coverage-bar-fill--amber  { background: var(--color-warning); }
.coverage-bar-fill--red    { background: var(--color-danger); }
.coverage-bar-pct {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--color-text);
    text-align: right;
    white-space: nowrap;
}

.coverage-breakdowns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}
.coverage-breakdown {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
}
.coverage-breakdown-title {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
}
.coverage-breakdown-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: var(--color-text-muted);
    padding: 0.1rem 0;
}
.coverage-breakdown-key {
    font-family: var(--font-mono);
    color: var(--color-text-muted);
}
.coverage-breakdown-val {
    font-weight: 600;
    color: var(--color-text);
}

.coverage-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

/* ------------------------------------------------------------------ Matching results */
.matching-result-block {
    margin-top: 1rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 0.85rem 1rem;
    font-size: 0.82rem;
}
.matching-result-header {
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 0.6rem;
}
.badge-converged {
    display: inline-block;
    background: rgba(74,222,128,0.12);
    color: var(--color-success);
    border: 1px solid rgba(74,222,128,0.3);
    border-radius: 100px;
    padding: 0.05rem 0.5rem;
    font-size: 0.72rem;
    font-weight: 600;
}
.badge-warn {
    display: inline-block;
    background: rgba(251,191,36,0.12);
    color: var(--color-warning);
    border: 1px solid rgba(251,191,36,0.3);
    border-radius: 100px;
    padding: 0.05rem 0.5rem;
    font-size: 0.72rem;
    font-weight: 600;
}
.matching-pass-block {
    margin-top: 0.5rem;
}
.matching-pass-label {
    font-weight: 700;
    color: var(--color-text-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
}
.matching-rule-list {
    margin-top: 0.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
}
.matching-rule-row {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    background: rgba(255,255,255,0.03);
}
.rule-name {
    font-family: var(--font-mono);
    font-size: 0.78rem;
    color: var(--color-accent);
    min-width: 100px;
}
.rule-stat {
    font-size: 0.78rem;
    color: var(--color-text);
}
.rule-discord { color: var(--color-success); }
.rule-stub    { color: var(--color-text-muted); }
.rule-nothing { font-size: 0.78rem; color: var(--color-text-muted); font-style: italic; }
.rule-no-change { opacity: 0.6; }
.matching-totals {
    margin-top: 0.65rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--color-border);
    color: var(--color-text);
    font-weight: 600;
    font-size: 0.82rem;
}

.coverage-loading {
    color: var(--color-text-muted);
    font-size: 0.85rem;
    padding: 0.5rem 0;
}
.coverage-error {
    color: var(--color-danger);
    font-size: 0.85rem;
    padding: 0.5rem 0;
}

/* ------------------------------------------------------------------ Drift detection panel */
.drift-panel {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.25rem 1.5rem;
    margin-bottom: 2rem;
}
.drift-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    gap: 1rem;
    flex-wrap: wrap;
}
.drift-panel-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
}
.drift-rule-list {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    margin-bottom: 1rem;
}
.drift-rule-row {
    display: grid;
    grid-template-columns: 1.5rem 180px 80px 100px 80px;
    gap: 0.5rem 0.75rem;
    align-items: center;
    font-size: 0.82rem;
}
.drift-rule-status { text-align: center; font-size: 1rem; }
.drift-rule-name {
    font-family: var(--font-mono);
    color: var(--color-text);
    font-size: 0.8rem;
}
.drift-rule-open {
    font-weight: 600;
    color: var(--color-text);
}
.drift-rule-open--warn { color: var(--color-warning); }
.drift-rule-resolved { color: var(--color-text-muted); font-size: 0.78rem; }
.drift-rule-mode {
    font-size: 0.72rem;
    padding: 0.1rem 0.4rem;
    border-radius: 100px;
    border: 1px solid;
    white-space: nowrap;
}
.drift-rule-mode--auto { border-color: var(--color-success); color: var(--color-success); }
.drift-rule-mode--manual { border-color: rgba(251,191,36,0.4); color: var(--color-warning); }
.drift-rule-mode--info { border-color: var(--color-info); color: var(--color-info); }
.drift-last-scan {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
}
.drift-scan-results {
    margin-top: 0.75rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
    font-size: 0.82rem;
    display: none;
}
.drift-scan-result-row {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    padding: 0.2rem 0;
    border-bottom: 1px solid var(--color-border);
}
.drift-scan-result-row:last-child { border-bottom: none; }
.drift-result-type {
    font-family: var(--font-mono);
    font-size: 0.78rem;
    color: var(--color-accent);
    min-width: 180px;
}
.drift-result-detected {
    color: var(--color-text);
    font-size: 0.78rem;
}
.drift-result-mitigated {
    color: var(--color-success);
    font-size: 0.78rem;
}

/* ------------------------------------------------------------------ Drift event log */
.drift-log {
    margin-top: 1rem;
    border-top: 1px solid var(--color-border);
    padding-top: 0.75rem;
}
.drift-log-title {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
    margin-bottom: 0.6rem;
}
.drift-log-empty {
    color: var(--color-text-muted);
    font-size: 0.85rem;
    padding: 0.5rem 0;
}
.drift-log-entry {
    display: grid;
    grid-template-columns: 16px 1fr auto;
    gap: 0.5rem 0.75rem;
    align-items: baseline;
    padding: 0.45rem 0;
    border-bottom: 1px solid var(--color-border);
    font-size: 0.85rem;
}
.drift-log-entry:last-child { border-bottom: none; }
.drift-log-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-top: 0.3rem;
    flex-shrink: 0;
    align-self: start;
}
.drift-log-dot--open     { background: var(--color-warning); }
.drift-log-dot--resolved { background: var(--color-success); }
.drift-log-body { min-width: 0; }
.drift-log-type {
    font-size: 0.72rem;
    font-family: var(--font-mono);
    color: var(--color-text-muted);
    margin-bottom: 0.15rem;
}
.drift-log-summary { color: var(--color-text); line-height: 1.4; }
.drift-log-meta {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    white-space: nowrap;
    text-align: right;
}
.drift-log-meta--resolved { color: var(--color-success); }

/* ------------------------------------------------------------------ Rule cards */
.dq-rules {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 2rem;
}

.dq-rule-card {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1rem 1.25rem;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.5rem 1.5rem;
    align-items: start;
}
.dq-rule-card:hover {
    border-color: var(--color-border-light);
}

.dq-rule-top {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    flex-wrap: wrap;
}
.dq-rule-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--color-text);
}
.dq-rule-type {
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--color-text-muted);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 0.1rem 0.4rem;
}
.dq-rule-badge {
    font-size: 0.7rem;
    font-weight: 700;
    padding: 0.15rem 0.5rem;
    border-radius: 100px;
    white-space: nowrap;
}
.dq-rule-badge--auto {
    background: rgba(74,222,128,0.12);
    color: var(--color-success);
    border: 1px solid var(--color-success);
}
.dq-rule-badge--manual {
    background: rgba(251,191,36,0.10);
    color: var(--color-warning);
    border: 1px solid rgba(251,191,36,0.4);
}

.dq-rule-desc {
    font-size: 0.82rem;
    color: var(--color-text-muted);
    margin-top: 0.2rem;
    grid-column: 1;
}
.dq-rule-stats {
    display: flex;
    gap: 1.25rem;
    margin-top: 0.35rem;
    grid-column: 1;
    flex-wrap: wrap;
}
.dq-stat {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}
.dq-stat__value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--color-text);
    line-height: 1.2;
}
.dq-stat__value--open {
    color: var(--color-warning);
}
.dq-stat__value--zero {
    color: var(--color-text-muted);
}
.dq-stat__label {
    font-size: 0.7rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
.dq-rule-last {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
    grid-column: 1;
}

.dq-rule-actions {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    grid-row: 1 / span 4;
    grid-column: 2;
    align-items: flex-end;
    padding-top: 0.1rem;
}

/* ------------------------------------------------------------------ Severity badge */
.sev {
    display: inline-block;
    padding: 0.12rem 0.5rem;
    border-radius: 100px;
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    white-space: nowrap;
}
.sev-warning { background: rgba(251,191,36,0.15); color: var(--color-warning); border: 1px solid var(--color-warning); }
.sev-error   { background: rgba(248,113,113,0.15); color: var(--color-danger);  border: 1px solid var(--color-danger); }
.sev-info    { background: rgba(96,165,250,0.12);  color: var(--color-info);    border: 1px solid var(--color-info); }

/* ------------------------------------------------------------------ Recent findings */
.dq-findings-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
    gap: 0.5rem;
}
.dq-findings-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
}
.dq-findings-subtitle {
    font-size: 0.8rem;
    color: var(--color-text-muted);
}

.issue-type-chip {
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--color-text-muted);
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 0.1rem 0.4rem;
    white-space: nowrap;
}
.td-summary { max-width: 340px; }
.td-entity  { font-size: 0.8rem; color: var(--color-text-muted); white-space: nowrap; }
.td-age     { font-size: 0.78rem; color: var(--color-text-muted); white-space: nowrap; }
.td-status  { font-size: 0.78rem; white-space: nowrap; }

.resolved-label {
    color: var(--color-success);
    font-size: 0.75rem;
}
.open-label {
    color: var(--color-warning);
    font-size: 0.75rem;
}


.no-pool-notice {
    background: rgba(251,191,36,0.08);
    border: 1px solid rgba(251,191,36,0.3);
    border-radius: var(--radius);
    padding: 1rem 1.25rem;
    color: var(--color-warning);
    font-size: 0.875rem;
}

/* ------------------------------------------------------------------ Action feedback */
.dq-action-feedback {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    background: var(--color-bg-panel);
    border: 1px solid var(--color-success);
    border-radius: var(--radius);
    padding: 0.6rem 1rem;
    color: var(--color-success);
    font-size: 0.875rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.2s, transform 0.2s;
    pointer-events: none;
    z-index: 100;
}
.dq-action-feedback.visible {
    opacity: 1;
    transform: translateY(0);
}

/* ------------------------------------------------------------------ Section divider */
.section-divider {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 2rem 0;
}
.section-heading {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="dq-header">
    <div>
        <h1 class="admin-title">Data Quality</h1>
        <p class="text-muted text-sm" style="margin-top:0.25rem">
            Matching coverage and rules-based detection for guild identity issues.
        </p>
    </div>
    {% if pool_available %}
    <div class="dq-header-actions">
        <button class="btn btn-secondary btn-sm" onclick="runScanAll(this)">
            Run Full Scan
        </button>
        <a href="/admin/audit-log" class="btn btn-secondary btn-sm">
            Audit Log â†’
        </a>
    </div>
    {% endif %}
</div>

{% if not pool_available %}
<div class="no-pool-notice">
    Guild sync pool not available â€” configure BLIZZARD_CLIENT_ID/SECRET and restart the app
    to enable data quality operations.
</div>
{% else %}

{# ------------------------------------------------------------------ Coverage panel #}
<div class="coverage-panel">
    <div class="coverage-panel-title">Matching Coverage</div>
    <div id="coverage-loading" class="coverage-loading">Loading coverage statsâ€¦</div>
    <div id="coverage-content" style="display:none">
        <div class="coverage-bars" id="coverage-bars"></div>
        <div class="coverage-breakdowns" id="coverage-breakdowns"></div>
        <div class="coverage-actions">
            <button class="btn btn-secondary btn-sm" onclick="runMatchingNow(this)">
                Run Matching
            </button>
            <button class="btn btn-secondary btn-sm" onclick="loadCoverage()">
                Refresh Stats
            </button>
        </div>
        <div id="matching-results" style="display:none"></div>
    </div>
    <div id="coverage-error" class="coverage-error" style="display:none"></div>
</div>

{# ------------------------------------------------------------------ Drift detection panel #}
<div class="drift-panel" id="drift-panel">
    <div class="drift-panel-header">
        <span class="drift-panel-title">Drift Detection</span>
        <button class="btn btn-secondary btn-sm" onclick="runDriftScan(this)">
            Run Drift Scan
        </button>
    </div>
    <div id="drift-loading" class="coverage-loading" style="display:none">Running drift scanâ€¦</div>
    <div id="drift-rules-content">
        <div class="drift-rule-list" id="drift-rule-rows">
            {# Populated by loadDriftSummary() #}
        </div>
        <div class="drift-last-scan" id="drift-last-scan"></div>
    </div>
    <div class="drift-scan-results" id="drift-scan-results"></div>
    <div class="drift-log" id="drift-log" style="display:none">
        <div class="drift-log-title">Recent Events (30 days)</div>
        <div id="drift-log-entries"></div>
    </div>
</div>

<hr class="section-divider">
<div class="section-heading">Audit Rules</div>

{# ------------------------------------------------------------------ Rules panel #}
{% if rules_with_stats %}
<div class="dq-rules">
    {% for entry in rules_with_stats %}
    {% set rule = entry.rule %}
    <div class="dq-rule-card" id="rule-{{ rule.issue_type }}">

        <div class="dq-rule-top">
            <span class="dq-rule-name">{{ rule.name }}</span>
            <span class="dq-rule-type">{{ rule.issue_type }}</span>
            <span class="sev sev-{{ rule.severity }}">{{ rule.severity }}</span>
            {% if rule.auto_mitigate %}
                <span class="dq-rule-badge dq-rule-badge--auto">âš¡ Auto-fix</span>
            {% else %}
                <span class="dq-rule-badge dq-rule-badge--manual">ðŸ‘¤ Manual</span>
            {% endif %}
        </div>

        <div class="dq-rule-desc">{{ rule.description }}</div>

        <div class="dq-rule-stats">
            <div class="dq-stat">
                <span class="dq-stat__value {% if entry.open_count > 0 %}dq-stat__value--open{% else %}dq-stat__value--zero{% endif %}">
                    {{ entry.open_count }}
                </span>
                <span class="dq-stat__label">Open</span>
            </div>
            <div class="dq-stat">
                <span class="dq-stat__value {% if entry.resolved_30d == 0 %}dq-stat__value--zero{% endif %}">
                    {{ entry.resolved_30d }}
                </span>
                <span class="dq-stat__label">Resolved (30d)</span>
            </div>
        </div>

        {% if entry.last_triggered %}
        <div class="dq-rule-last">
            Last detected: {{ entry.last_triggered.strftime('%Y-%m-%d %H:%M UTC') }}
        </div>
        {% else %}
        <div class="dq-rule-last text-muted">Never detected</div>
        {% endif %}

        <div class="dq-rule-actions">
            <button class="btn btn-secondary btn-sm"
                    onclick="runScan('{{ rule.issue_type }}', this)"
                    title="Run detection for this rule now">
                Scan
            </button>
            {% if rule.mitigate_fn is not none and entry.open_count > 0 %}
            <button class="btn btn-primary btn-sm"
                    onclick="runFixAll('{{ rule.issue_type }}', this)"
                    title="Attempt to fix all open {{ rule.issue_type }} issues">
                Fix All ({{ entry.open_count }})
            </button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<hr class="section-divider">
<div class="section-heading">Recent Findings</div>

{# ------------------------------------------------------------------ Recent findings #}
<div class="dq-findings-header">
    <div>
        <span class="dq-findings-subtitle">last 50 issues</span>
    </div>
</div>

{% if recent_issues %}
<div class="table-wrapper">
    <table class="table">
        <thead>
            <tr>
                <th>Severity</th>
                <th>Type</th>
                <th>Summary</th>
                <th>Entity</th>
                <th>Age</th>
                <th>Status</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for issue in recent_issues %}
            <tr id="issue-row-{{ issue.id }}">
                <td>
                    <span class="sev sev-{{ issue.severity }}">{{ issue.severity }}</span>
                </td>
                <td>
                    <span class="issue-type-chip">{{ issue.issue_type }}</span>
                </td>
                <td class="td-summary">{{ issue.summary }}</td>
                <td class="td-entity">
                    {% if issue.character_name %}
                        WoW: <strong>{{ issue.character_name }}</strong>
                    {% elif issue.discord_display_name or issue.discord_username %}
                        Discord: <strong>{{ issue.discord_display_name or issue.discord_username }}</strong>
                    {% else %}
                        â€”
                    {% endif %}
                </td>
                <td class="td-age">
                    {{ issue.created_at.strftime('%Y-%m-%d') }}<br>
                    <span class="text-xs">{{ issue.created_at.strftime('%H:%M UTC') }}</span>
                </td>
                <td class="td-status">
                    {% if issue.resolved_at %}
                        <span class="resolved-label">âœ“ Resolved</span><br>
                        <span class="text-xs text-muted">{{ issue.resolved_by or 'auto' }}</span>
                    {% else %}
                        <span class="open-label">Open</span>
                    {% endif %}
                </td>
                <td>
                    {% if not issue.resolved_at %}
                    {% set rule = none %}
                    {% for entry in rules_with_stats %}
                        {% if entry.rule.issue_type == issue.issue_type and entry.rule.mitigate_fn is not none %}
                            {% set rule = entry.rule %}
                        {% endif %}
                    {% endfor %}
                    {% if rule %}
                    <button class="btn btn-secondary btn-sm"
                            onclick="runFix({{ issue.id }}, this)"
                            title="Attempt fix for this issue">
                        Fix
                    </button>
                    {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div style="text-align:center; padding:2rem 1rem; color:var(--color-text-muted)">
    No issues recorded yet â€” run a scan to detect problems.
</div>
{% endif %}

{% endif %}{# /pool_available #}

{# Action feedback toast #}
<div class="dq-action-feedback" id="dq-toast"></div>

{% endblock %}

{% block scripts %}
<script>
function showToast(msg, isError) {
    const el = document.getElementById('dq-toast');
    el.textContent = msg;
    el.style.borderColor = isError ? 'var(--color-danger)' : 'var(--color-success)';
    el.style.color = isError ? 'var(--color-danger)' : 'var(--color-success)';
    el.classList.add('visible');
    setTimeout(() => el.classList.remove('visible'), 3000);
}

// --------------------------------------------------------------------------
// Coverage dashboard
// --------------------------------------------------------------------------

function coverageColor(pct) {
    if (pct >= 80) return 'green';
    if (pct >= 50) return 'amber';
    return 'red';
}

function renderBar(label, matched, total, pct) {
    const cls = coverageColor(pct);
    return `<div class="coverage-bar-row">
        <span class="coverage-bar-label">${label}</span>
        <div class="coverage-bar-track">
            <div class="coverage-bar-fill coverage-bar-fill--${cls}" style="width:${pct}%"></div>
        </div>
        <span class="coverage-bar-pct">${matched}/${total} (${pct}%)</span>
    </div>`;
}

function renderBreakdown(title, data) {
    const rows = Object.entries(data)
        .sort((a, b) => b[1] - a[1])
        .map(([k, v]) => `<div class="coverage-breakdown-row">
            <span class="coverage-breakdown-key">${k}</span>
            <span class="coverage-breakdown-val">${v}</span>
        </div>`)
        .join('');
    return `<div class="coverage-breakdown">
        <div class="coverage-breakdown-title">${title}</div>
        ${rows || '<div class="coverage-breakdown-row" style="color:var(--color-text-muted)">No data yet</div>'}
    </div>`;
}

async function loadCoverage() {
    const loading = document.getElementById('coverage-loading');
    const content = document.getElementById('coverage-content');
    const errorEl = document.getElementById('coverage-error');

    loading.style.display = '';
    content.style.display = 'none';
    errorEl.style.display = 'none';

    try {
        const r = await fetch('/admin/matching/coverage');
        const d = await r.json();
        if (!d.ok) {
            errorEl.textContent = 'Error: ' + (d.error || 'Unknown error');
            errorEl.style.display = '';
            loading.style.display = 'none';
            return;
        }

        const s = d.data.summary;
        const barsEl = document.getElementById('coverage-bars');
        barsEl.innerHTML =
            renderBar('Characters', s.matched_characters, s.total_characters, s.character_coverage_pct) +
            renderBar('Discord Users', s.matched_discord_users, s.total_discord_users, s.discord_coverage_pct) +
            renderBar('Players w/ Discord', s.players_with_discord, s.total_players, s.discord_link_pct);

        const breakdownsEl = document.getElementById('coverage-breakdowns');
        breakdownsEl.innerHTML =
            renderBreakdown('By Link Source', d.data.by_link_source) +
            renderBreakdown('By Confidence', d.data.by_confidence);

        loading.style.display = 'none';
        content.style.display = '';

    } catch(e) {
        errorEl.textContent = 'Failed to load coverage stats.';
        errorEl.style.display = '';
        loading.style.display = 'none';
    }
}

async function runMatchingNow(btn) {
    btn.disabled = true;
    btn.textContent = 'Runningâ€¦';
    const resultsEl = document.getElementById('matching-results');
    resultsEl.style.display = 'none';
    resultsEl.innerHTML = '';
    try {
        const r = await fetch('/api/guild-sync/matching/trigger', { method: 'POST' });
        const d = await r.json();
        if (d.ok) {
            renderMatchingResults(d.data, resultsEl);
            await loadCoverage();
        } else {
            showToast('Error: ' + (d.error || 'Unknown error'), true);
        }
    } catch(e) {
        showToast('Request failed', true);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Run Matching';
    }
}

function renderMatchingResults(data, el) {
    const passes = {};
    for (const r of (data.results || [])) {
        if (!passes[r.pass]) passes[r.pass] = [];
        passes[r.pass].push(r);
    }

    const converged = data.converged;
    const passCount = data.passes || 0;
    const totals = data.totals || {};

    let html = '<div class="matching-result-block">';
    html += `<div class="matching-result-header">`;
    html += `Matching complete â€” ${passCount} pass${passCount !== 1 ? 'es' : ''}`;
    html += converged
        ? ' <span class="badge-converged">converged âœ“</span>'
        : ' <span class="badge-warn">hit max passes</span>';
    html += '</div>';

    for (const [passNum, rules] of Object.entries(passes)) {
        html += `<div class="matching-pass-block">`;
        html += `<span class="matching-pass-label">Pass ${passNum}</span>`;
        html += `<div class="matching-rule-list">`;
        for (const r of rules) {
            const changed = r.players_created > 0 || r.chars_linked > 0;
            if (changed) {
                html += `<div class="matching-rule-row">`;
                html += `<span class="rule-name">${r.rule}</span>`;
                html += `<span class="rule-stat">${r.players_created} player${r.players_created !== 1 ? 's' : ''} created</span>`;
                html += `<span class="rule-stat">${r.chars_linked} char${r.chars_linked !== 1 ? 's' : ''} linked</span>`;
                if (r.discord_linked > 0) {
                    html += `<span class="rule-stat rule-discord">${r.discord_linked} with Discord</span>`;
                }
                if (r.stubs_created > 0) {
                    html += `<span class="rule-stat rule-stub">${r.stubs_created} stub${r.stubs_created !== 1 ? 's' : ''}</span>`;
                }
                html += '</div>';
            } else {
                html += `<div class="matching-rule-row rule-no-change">`;
                html += `<span class="rule-name">${r.rule}</span>`;
                html += `<span class="rule-nothing">nothing new</span>`;
                html += '</div>';
            }
        }
        html += '</div></div>';
    }

    if (totals.players_created > 0 || totals.chars_linked > 0) {
        html += `<div class="matching-totals">`;
        html += `Totals: ${totals.players_created} player${totals.players_created !== 1 ? 's' : ''} created, `;
        html += `${totals.chars_linked} char${totals.chars_linked !== 1 ? 's' : ''} linked`;
        if (totals.no_discord_match > 0) {
            html += `, ${totals.no_discord_match} stub${totals.no_discord_match !== 1 ? 's' : ''}`;
        }
        html += '</div>';
    } else {
        html += '<div class="matching-totals">Nothing new to link â€” all characters already matched.</div>';
    }

    html += '</div>';
    el.innerHTML = html;
    el.style.display = '';
}

document.addEventListener('DOMContentLoaded', () => {
    loadCoverage();
    loadDriftSummary();
});

// --------------------------------------------------------------------------
// Drift detection
// --------------------------------------------------------------------------

const DRIFT_RULE_META = {
    note_mismatch:         { label: 'note_mismatch',         mode: 'auto',   modeLabel: 'âš¡ Auto-fix' },
    link_contradicts_note: { label: 'link_contradicts_note', mode: 'manual', modeLabel: 'ðŸ‘¤ Manual' },
    duplicate_discord:     { label: 'duplicate_discord',     mode: 'manual', modeLabel: 'ðŸ‘¤ Manual' },
    stale_discord_link:    { label: 'stale_discord_link',    mode: 'info',   modeLabel: 'â„¹ Info' },
};

async function loadDriftSummary() {
    try {
        const r = await fetch('/admin/drift/summary');
        const d = await r.json();
        if (!d.ok) return;
        renderDriftRules(d.data.summary);
        renderDriftLog(d.data.log || []);
    } catch(e) {
        // silently fail â€” drift summary is non-critical
    }
}

function renderDriftRules(data) {
    const container = document.getElementById('drift-rule-rows');
    const lastEl = document.getElementById('drift-last-scan');
    if (!container) return;

    let latestScan = null;
    const rows = Object.entries(DRIFT_RULE_META).map(([type, meta]) => {
        const s = data[type] || { open_count: 0, resolved_30d: 0, last_triggered: null };
        const hasOpen = s.open_count > 0;
        const statusIcon = hasOpen ? 'âš ï¸' : 'âœ…';
        if (s.last_triggered && (!latestScan || s.last_triggered > latestScan)) {
            latestScan = s.last_triggered;
        }
        return `<div class="drift-rule-row">
            <span class="drift-rule-status">${statusIcon}</span>
            <span class="drift-rule-name">${meta.label}</span>
            <span class="drift-rule-open ${hasOpen ? 'drift-rule-open--warn' : ''}">${s.open_count} open</span>
            <span class="drift-rule-resolved">${s.resolved_30d} fixed (30d)</span>
            <span class="drift-rule-mode drift-rule-mode--${meta.mode}">${meta.modeLabel}</span>
        </div>`;
    }).join('');
    container.innerHTML = rows;

    if (latestScan) {
        const dt = new Date(latestScan);
        const now = new Date();
        const diffH = Math.round((now - dt) / 3600000);
        const ago = diffH < 1 ? 'just now'
                  : diffH < 24 ? `${diffH}h ago`
                  : `${Math.round(diffH/24)}d ago`;
        lastEl.textContent = `Last drift issue detected: ${ago}`;
    } else {
        lastEl.textContent = 'No drift issues detected yet.';
    }
}

async function runDriftScan(btn) {
    btn.disabled = true;
    btn.textContent = 'Scanningâ€¦';
    const loadingEl = document.getElementById('drift-loading');
    const resultsEl = document.getElementById('drift-scan-results');
    loadingEl.style.display = '';
    resultsEl.style.display = 'none';
    resultsEl.innerHTML = '';
    try {
        const r = await fetch('/admin/drift/scan', { method: 'POST' });
        const d = await r.json();
        if (d.ok) {
            renderDriftScanResults(d.data, resultsEl);
            await loadDriftSummary();
        } else {
            showToast('Drift scan error: ' + (d.error || 'Unknown'), true);
        }
    } catch(e) {
        showToast('Drift scan request failed', true);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Run Drift Scan';
        loadingEl.style.display = 'none';
    }
}

function renderDriftScanResults(data, el) {
    const nm = data.note_mismatch || {};
    const lc = data.link_contradicts_note || {};
    const dd = data.duplicate_discord || {};

    let html = '';

    html += `<div class="drift-scan-result-row">
        <span class="drift-result-type">note_mismatch</span>
        <span class="drift-result-detected">${nm.detected || 0} detected</span>
        ${(nm.mitigated || 0) > 0 ? `<span class="drift-result-mitigated">${nm.mitigated} auto-fixed</span>` : ''}
    </div>`;

    html += `<div class="drift-scan-result-row">
        <span class="drift-result-type">link_contradicts_note</span>
        <span class="drift-result-detected">${lc.detected || 0} detected</span>
    </div>`;

    html += `<div class="drift-scan-result-row">
        <span class="drift-result-type">duplicate_discord / stale</span>
        <span class="drift-result-detected">${dd.detected || 0} detected</span>
    </div>`;

    el.innerHTML = html;
    el.style.display = '';
}

function renderDriftLog(entries) {
    const section = document.getElementById('drift-log');
    const container = document.getElementById('drift-log-entries');
    if (!section || !container) return;

    if (!entries || entries.length === 0) {
        container.innerHTML = '<div class="drift-log-empty">No drift events in the last 30 days.</div>';
        section.style.display = '';
        return;
    }

    container.innerHTML = entries.map(e => {
        const isResolved = !!e.resolved_at;
        const dotClass = isResolved ? 'drift-log-dot--resolved' : 'drift-log-dot--open';
        const created = new Date(e.created_at);
        const age = formatAge(created);
        let meta = age;
        if (isResolved) {
            const by = e.resolved_by ? ` by ${e.resolved_by}` : '';
            meta = `auto-fixed${by} Â· ${age}`;
        }
        return `<div class="drift-log-entry">
            <span class="drift-log-dot ${dotClass}"></span>
            <div class="drift-log-body">
                <div class="drift-log-type">${e.issue_type}</div>
                <div class="drift-log-summary">${escHtml(e.summary)}</div>
            </div>
            <div class="drift-log-meta ${isResolved ? 'drift-log-meta--resolved' : ''}">${meta}</div>
        </div>`;
    }).join('');

    section.style.display = '';
}

function formatAge(date) {
    const diffMs = Date.now() - date.getTime();
    const diffH = Math.floor(diffMs / 3600000);
    if (diffH < 1) return 'just now';
    if (diffH < 24) return `${diffH}h ago`;
    const diffD = Math.floor(diffH / 24);
    if (diffD < 7) return `${diffD}d ago`;
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// --------------------------------------------------------------------------
// Existing rule / fix / alias functions
// --------------------------------------------------------------------------

async function runScanAll(btn) {
    btn.disabled = true;
    btn.textContent = 'Scanningâ€¦';
    try {
        const r = await fetch('/admin/data-quality/scan', { method: 'POST' });
        const d = await r.json();
        if (d.ok) {
            showToast('Scan started â€” reload page in a moment to see results.');
        } else {
            showToast('Error: ' + d.error, true);
        }
    } catch(e) {
        showToast('Request failed', true);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Run Full Scan';
    }
}

async function runScan(issueType, btn) {
    btn.disabled = true;
    const orig = btn.textContent;
    btn.textContent = 'Scanningâ€¦';
    try {
        const r = await fetch('/admin/data-quality/scan/' + issueType, { method: 'POST' });
        const d = await r.json();
        if (d.ok) {
            showToast('Scan for ' + issueType + ' started.');
        } else {
            showToast('Error: ' + d.error, true);
        }
    } catch(e) {
        showToast('Request failed', true);
    } finally {
        btn.disabled = false;
        btn.textContent = orig;
    }
}

async function runFix(issueId, btn) {
    btn.disabled = true;
    btn.textContent = 'Fixingâ€¦';
    try {
        const r = await fetch('/admin/data-quality/fix/' + issueId, { method: 'POST' });
        const d = await r.json();
        if (d.ok) {
            showToast('Fix started for issue #' + issueId + ' â€” reload to check result.');
        } else {
            showToast('Error: ' + d.error, true);
            btn.disabled = false;
            btn.textContent = 'Fix';
        }
    } catch(e) {
        showToast('Request failed', true);
        btn.disabled = false;
        btn.textContent = 'Fix';
    }
}

async function runFixAll(issueType, btn) {
    btn.disabled = true;
    const orig = btn.textContent;
    btn.textContent = 'Runningâ€¦';
    try {
        const r = await fetch('/admin/data-quality/fix-all/' + issueType, { method: 'POST' });
        const d = await r.json();
        if (d.ok) {
            showToast('Fix-all for ' + issueType + ' started â€” reload in a moment.');
        } else {
            showToast('Error: ' + d.error, true);
            btn.disabled = false;
            btn.textContent = orig;
        }
    } catch(e) {
        showToast('Request failed', true);
        btn.disabled = false;
        btn.textContent = orig;
    }
}
</script>
{% endblock %}
