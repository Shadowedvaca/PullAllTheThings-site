{% extends "base_admin.html" %}
{% block title %}Crafting Sync â€” Admin â€” Pull All The Things{% endblock %}
{% block nav_crafting_sync %}active{% endblock %}

{% block head %}
<style>
.cs-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}
@media (max-width: 700px) { .cs-grid { grid-template-columns: 1fr; } }

.cs-card {
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 1.25rem 1.5rem;
}
.cs-card__title {
    font-family: 'Cinzel', serif;
    color: var(--color-gold);
    font-size: 1rem;
    margin: 0 0 0.25rem 0;
}
.cs-card__subtitle {
    color: var(--color-text-muted);
    font-size: 0.8rem;
    margin-bottom: 1rem;
}
.cs-stat-row {
    display: flex;
    justify-content: space-between;
    padding: 0.35rem 0;
    border-bottom: 1px solid #2a2a2e;
    font-size: 0.9rem;
}
.cs-stat-row:last-child { border-bottom: none; }
.cs-stat-row__label { color: var(--color-text-muted); }
.cs-stat-row__val { font-weight: 600; color: var(--color-text); }
.cs-badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
}
.cs-badge--daily { background: var(--color-gold); color: #0a0a0b; }
.cs-badge--weekly { background: #333; color: #aaa; }
.cs-badge--new-exp { background: #4ade80; color: #0a0a0b; }

.cs-season-box {
    background: rgba(212,168,75,0.08);
    border: 1px solid rgba(212,168,75,0.25);
    border-radius: 6px;
    padding: 0.85rem 1rem;
    margin-bottom: 1rem;
}
.cs-season-box__name {
    font-family: 'Cinzel', serif;
    color: var(--color-gold);
    font-size: 1rem;
    margin: 0 0 0.25rem 0;
}
.cs-season-box__meta {
    font-size: 0.82rem;
    color: var(--color-text-muted);
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}
.cs-season-hint {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    margin-top: 0.75rem;
    line-height: 1.5;
}
.cs-season-hint a {
    color: var(--color-gold);
    text-decoration: none;
}
.cs-season-hint a:hover { text-decoration: underline; }
.cs-btn-row {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.25rem;
    flex-wrap: wrap;
}
.cs-link {
    display: inline-block;
    font-size: 0.85rem;
    color: var(--color-gold);
    text-decoration: none;
}
.cs-link:hover { text-decoration: underline; }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <h1 class="admin-title">Crafting Sync</h1>
    <a href="/crafting-corner" class="cs-link" target="_blank">&#x2692; View Crafting Corner â†—</a>
</div>

<div class="cs-grid">

    <!-- Sync Status Card -->
    <div class="cs-card">
        <h2 class="cs-card__title">Sync Status</h2>
        <p class="cs-card__subtitle">Current crafting recipe data for all guild characters.</p>

        <div class="cs-stat-row">
            <span class="cs-stat-row__label">Cadence</span>
            <span class="cs-stat-row__val" id="cs-cadence-val">â€”</span>
        </div>
        <div class="cs-stat-row">
            <span class="cs-stat-row__label">Last Sync</span>
            <span class="cs-stat-row__val" id="cs-last-sync">â€”</span>
        </div>
        <div class="cs-stat-row">
            <span class="cs-stat-row__label">Characters Processed</span>
            <span class="cs-stat-row__val" id="cs-chars-processed">â€”</span>
        </div>
        <div class="cs-stat-row">
            <span class="cs-stat-row__label">Recipes Found</span>
            <span class="cs-stat-row__val" id="cs-recipes-found">â€”</span>
        </div>
        <div class="cs-stat-row">
            <span class="cs-stat-row__label">Last Duration</span>
            <span class="cs-stat-row__val" id="cs-duration">â€”</span>
        </div>

        <div class="cs-btn-row">
            <button class="btn btn-primary" id="cs-force-btn">Force Refresh Now</button>
        </div>
        <p style="font-size:0.8rem;color:var(--color-text-muted);margin-top:0.5rem" id="cs-trigger-status"></p>
    </div>

    <!-- Season Info Card -->
    <div class="cs-card">
        <h2 class="cs-card__title">Current Season</h2>
        <p class="cs-card__subtitle">Cadence is computed from the active raid season's start date.</p>

        <div id="cs-season-box" class="cs-season-box" style="display:none">
            <p class="cs-season-box__name" id="cs-season-name">â€”</p>
            <div class="cs-season-box__meta">
                <span id="cs-season-start"></span>
                <span id="cs-season-flags"></span>
            </div>
        </div>
        <p id="cs-no-season" style="color:var(--color-text-muted);font-style:italic;display:none">
            No active season configured. The sync will run weekly until a season is set.
        </p>

        <p class="cs-season-hint">
            Season name, start date, and the "first of expansion" flag are managed in
            <a href="/admin/raid-tools">Admin â†’ Raid Tools</a>.
            The crafting sync cadence updates automatically when the active season changes.
        </p>
    </div>

    <!-- Discord Settings Card -->
    <div class="cs-card" style="grid-column: 1 / -1">
        <h2 class="cs-card__title">Discord Settings</h2>
        <p class="cs-card__subtitle">Configure which channels the bot posts to. Channels are pulled from the Discord server â€” if a channel is missing, go to <a href="/admin/reference-tables" class="cs-link">Admin â†’ Reference Tables</a> and click â†» Sync from Discord.</p>

        <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;margin-top:0.5rem">
            <label style="color:var(--color-text-muted);font-size:0.9rem;min-width:160px">Crafters Corner channel</label>
            <select id="cs-channel-select" class="form-control" style="max-width:320px;font-size:0.9rem">
                <option value="">â€” select channel â€”</option>
            </select>
            <button class="btn btn-primary" id="cs-channel-save" style="font-size:0.85rem;padding:0.4rem 1rem">Save</button>
            <span id="cs-channel-status" style="font-size:0.85rem"></span>
        </div>
        <p style="font-size:0.8rem;color:var(--color-text-muted);margin-top:0.6rem">
            Guild orders placed via the Crafting Corner will be posted to this channel.
            If the channel is not configured or cannot be found, users will see an error when placing orders.
        </p>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';

    function fmtDate(iso) {
        if (!iso) return 'Never';
        return new Date(iso).toLocaleString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric',
            hour: 'numeric', minute: '2-digit',
        });
    }
    function fmtDateOnly(iso) {
        if (!iso) return 'â€”';
        return new Date(iso).toLocaleDateString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric', timeZone: 'UTC',
        });
    }
    function fmtDuration(secs) {
        if (secs == null) return 'â€”';
        if (secs < 60) return secs.toFixed(1) + 's';
        return Math.floor(secs / 60) + 'm ' + Math.round(secs % 60) + 's';
    }

    // â”€â”€ Channel dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadChannelDropdown(selectedId) {
        const sel = document.getElementById('cs-channel-select');
        try {
            const resp = await fetch('/api/guild-sync/channels');
            const data = await resp.json();
            const textChannels = (data.data || []).filter(
                ch => ch.channel_type === 'text' || ch.channel_type === 'announcement'
            );
            if (!textChannels.length) {
                sel.innerHTML = '<option value="">No channels synced yet â€” sync in Reference Tables</option>';
                return;
            }
            // Group by category
            const byCategory = {};
            textChannels.forEach(ch => {
                const cat = ch.category_name || 'Uncategorized';
                (byCategory[cat] = byCategory[cat] || []).push(ch);
            });
            let html = '<option value="">â€” select channel â€”</option>';
            Object.keys(byCategory).sort().forEach(cat => {
                html += `<optgroup label="${cat}">`;
                byCategory[cat].forEach(ch => {
                    const lock = ch.is_public ? '' : ' ðŸ”’';
                    const sel_attr = ch.discord_channel_id === selectedId ? ' selected' : '';
                    html += `<option value="${ch.discord_channel_id}"${sel_attr}>#${ch.name}${lock}</option>`;
                });
                html += '</optgroup>';
            });
            sel.innerHTML = html;
        } catch (e) {
            sel.innerHTML = '<option value="">Failed to load channels</option>';
        }
    }

    document.getElementById('cs-channel-save').addEventListener('click', async function() {
        const channelId = document.getElementById('cs-channel-select').value || null;
        const statusEl = document.getElementById('cs-channel-status');
        this.disabled = true;
        try {
            const resp = await fetch('/api/crafting/admin/config', {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({crafters_corner_channel_id: channelId}),
            });
            const data = await resp.json();
            if (data.ok) {
                statusEl.textContent = channelId ? 'âœ“ Saved' : 'âœ“ Cleared';
                statusEl.style.color = 'var(--color-success)';
            } else {
                statusEl.textContent = 'âœ— ' + (data.detail || data.error || 'Save failed');
                statusEl.style.color = 'var(--color-danger)';
            }
        } catch (e) {
            statusEl.textContent = 'âœ— Network error';
            statusEl.style.color = 'var(--color-danger)';
        }
        this.disabled = false;
        setTimeout(() => { statusEl.textContent = ''; }, 3000);
    });

    // â”€â”€ Sync status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadConfig() {
        try {
            const [configResp, statusResp] = await Promise.all([
                fetch('/api/crafting/admin/config'),
                fetch('/api/crafting/sync-status'),
            ]);

            if (configResp.ok) {
                const data = await configResp.json();
                if (data.ok && data.data) {
                    const c = data.data;
                    loadChannelDropdown(c.crafters_corner_channel_id);
                    document.getElementById('cs-last-sync').textContent = fmtDate(c.last_sync_at);
                    document.getElementById('cs-chars-processed').textContent =
                        c.last_sync_characters_processed ?? 'â€”';
                    document.getElementById('cs-recipes-found').textContent =
                        c.last_sync_recipes_found ?? 'â€”';
                    document.getElementById('cs-duration').textContent =
                        fmtDuration(c.last_sync_duration_seconds);

                    // Season
                    if (c.season_name && c.season_name !== 'No season configured') {
                        document.getElementById('cs-season-box').style.display = 'block';
                        document.getElementById('cs-season-name').textContent = c.season_name;
                        document.getElementById('cs-season-start').textContent =
                            'Started: ' + fmtDateOnly(c.season_start_date);
                        if (c.is_new_expansion) {
                            document.getElementById('cs-season-flags').innerHTML =
                                '<span class="cs-badge cs-badge--new-exp">New Expansion</span> 28-day daily window';
                        } else {
                            document.getElementById('cs-season-flags').textContent =
                                '14-day daily window';
                        }
                    } else {
                        document.getElementById('cs-no-season').style.display = 'block';
                    }
                }
            }

            if (statusResp.ok) {
                const status = await statusResp.json();
                if (status.ok) {
                    const s = status.data;
                    const cadEl = document.getElementById('cs-cadence-val');
                    if (s.current_cadence === 'daily') {
                        cadEl.innerHTML = '<span class="cs-badge cs-badge--daily">Daily</span>' +
                            (s.daily_days_remaining > 0
                                ? ' &nbsp;' + s.daily_days_remaining + ' days remaining' : '');
                    } else {
                        cadEl.innerHTML = '<span class="cs-badge cs-badge--weekly">Weekly</span>';
                    }
                }
            }
        } catch (e) {
            console.error('Failed to load crafting config', e);
        }
    }

    document.getElementById('cs-force-btn').addEventListener('click', async function() {
        this.disabled = true;
        this.textContent = 'Triggering...';
        const statusEl = document.getElementById('cs-trigger-status');
        try {
            const resp = await fetch('/api/guild-sync/crafting/trigger', {method: 'POST'});
            const data = await resp.json();
            statusEl.textContent = data.ok
                ? 'âœ“ Sync triggered â€” check back in a few minutes.'
                : 'âœ— ' + (data.error || 'Failed to trigger.');
        } catch (e) {
            statusEl.textContent = 'âœ— Error triggering sync.';
        } finally {
            this.disabled = false;
            this.textContent = 'Force Refresh Now';
        }
    });

    loadConfig().catch(console.error);
})();
</script>
{% endblock %}
