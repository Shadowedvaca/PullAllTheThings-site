{% extends "base.html" %}
{% block title %}Roster â€” Pull All The Things{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/roster.css">
{% endblock %}

{% block content %}
<div class="roster-page">

    <div class="roster-header">
        <h1 class="roster-title">Guild Roster</h1>
        <p class="roster-subtitle">Pull All The Things &bull; Sen'jin &bull; US</p>
    </div>

    <div id="roster-loading" class="roster-loading">Loading rosterâ€¦</div>
    <div id="roster-error" class="roster-error" style="display:none"></div>

    {# â”€â”€ Composition section (shown once data loads) â”€â”€ #}
    <div id="comp-content" style="display:none">

        <section class="comp-section">
            <h2 class="comp-section-title">Role Distribution</h2>
            <div class="role-cards" id="role-cards"></div>
        </section>

        <section class="comp-section">
            <h2 class="comp-section-title">Wowhead Comp Analyzer</h2>
            <p class="comp-wowhead-note">View the current main-spec composition on Wowhead.</p>
            <a id="wowhead-btn" href="#" target="_blank" rel="noopener" class="btn btn-primary">
                ðŸ”— View Comp on Wowhead
            </a>
        </section>

        <section class="comp-section">
            <h2 class="comp-section-title">Full Roster</h2>
            <div class="roster-controls">
                <input
                    type="text"
                    id="roster-search"
                    class="roster-search"
                    placeholder="Search by name, class, specâ€¦"
                    autocomplete="off"
                >
                <label class="roster-alts-label">
                    <input type="checkbox" id="show-secondary">
                    Show Secondary
                </label>
                <label class="roster-alts-label">
                    <input type="checkbox" id="show-alts">
                    Show The Rest
                </label>
            </div>

            <table class="roster-table" id="roster-table" style="display:none">
                <thead>
                    <tr>
                        <th class="col-type" title="â­ Main Â· ðŸ”· Secondary Â· âšª Alt"></th>
                        <th class="sort-col" data-col="display_name">Player</th>
                        <th class="sort-col" data-col="character_name">Character</th>
                        <th class="sort-col" data-col="class_name">Class</th>
                        <th class="sort-col" data-col="spec_name">Spec</th>
                        <th class="sort-col" data-col="role_name">Role</th>
                        <th class="sort-col" data-col="rank_name">Rank</th>
                        <th class="sort-col num-col" data-col="item_level">iLvl</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="roster-tbody"></tbody>
            </table>

            <p id="roster-empty" class="roster-empty" style="display:none">No players found.</p>
        </section>

    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// ---------------------------------------------------------------------------
// Constants
// ---------------------------------------------------------------------------
const CLASS_COLORS = {
    "Death Knight": "#C41E3A",
    "Demon Hunter": "#A330C9",
    "Druid": "#FF7C0A",
    "Evoker": "#33937F",
    "Hunter": "#AAD372",
    "Mage": "#3FC7EB",
    "Monk": "#00FF98",
    "Paladin": "#F48CBA",
    "Priest": "#FFFFFF",
    "Rogue": "#FFF468",
    "Shaman": "#0070DD",
    "Warlock": "#8788EE",
    "Warrior": "#C69B3A"
};

const CLASS_EMOJIS = {
    "Druid": "ðŸŒ¿", "Paladin": "âš”ï¸", "Warlock": "ðŸ‘ï¸", "Priest": "âœ¨",
    "Mage": "ðŸ”®", "Hunter": "ðŸ¹", "Warrior": "âš”ï¸", "Shaman": "âš¡",
    "Monk": "â˜¯ï¸", "Death Knight": "ðŸ’€", "Demon Hunter": "ðŸ¦…",
    "Evoker": "ðŸ‰", "Rogue": "ðŸ—¡ï¸"
};

const ROLE_EMOJIS = {
    "Tank": "ðŸ›¡ï¸", "Healer": "ðŸ’š", "Melee DPS": "âš”ï¸", "Ranged DPS": "ðŸ¹"
};

const ROLE_TARGETS = { "Tank": 2, "Healer": 4, "Melee DPS": 7, "Ranged DPS": 7 };
const DPS_TOTAL_TARGET = 14;

const SPEC_CODES = {
    "Death Knight/Blood": "K1", "Death Knight/Frost": "K2", "Death Knight/Unholy": "K3",
    "Death Knight/San'layn": "K4",
    "Demon Hunter/Havoc": "Y1", "Demon Hunter/Vengeance": "Y2",
    "Druid/Balance": "D1", "Druid/Feral": "D2", "Druid/Guardian": "D3", "Druid/Restoration": "D4",
    "Evoker/Devastation": "V1", "Evoker/Preservation": "V2", "Evoker/Augmentation": "V3",
    "Hunter/Beast Mastery": "H1", "Hunter/Marksmanship": "H2", "Hunter/Survival": "H3",
    "Mage/Arcane": "M1", "Mage/Fire": "M2", "Mage/Frost": "M3",
    "Monk/Brewmaster": "O1", "Monk/Mistweaver": "O2", "Monk/Windwalker": "O3",
    "Paladin/Holy": "P1", "Paladin/Protection": "P2", "Paladin/Retribution": "P3",
    "Priest/Discipline": "R1", "Priest/Holy": "R2", "Priest/Shadow": "R3",
    "Rogue/Assassination": "U1", "Rogue/Outlaw": "U2", "Rogue/Subtlety": "U3",
    "Shaman/Elemental": "S1", "Shaman/Enhancement": "S2", "Shaman/Restoration": "S3",
    "Warlock/Affliction": "W1", "Warlock/Demonology": "W2", "Warlock/Destruction": "W3",
    "Warrior/Arms": "A1", "Warrior/Fury": "A2", "Warrior/Protection": "A3"
};

// ---------------------------------------------------------------------------
// State
// ---------------------------------------------------------------------------
let allPlayers = [];
let sortCol = 'display_name';
let sortDir = 1; // 1 = asc, -1 = desc

// ---------------------------------------------------------------------------
// Data loading
// ---------------------------------------------------------------------------
async function loadRoster() {
    try {
        const res = await fetch('/api/v1/guild/roster');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const { data } = await res.json();
        allPlayers = data.players || [];
        document.getElementById('roster-loading').style.display = 'none';
        document.getElementById('comp-content').style.display = '';
        document.getElementById('roster-table').style.display = '';
        renderComposition();
        renderRoster();
    } catch (err) {
        document.getElementById('roster-loading').style.display = 'none';
        const el = document.getElementById('roster-error');
        el.textContent = 'Could not load roster. Please try again later.';
        el.style.display = '';
    }
}

// ---------------------------------------------------------------------------
// Roster section
// ---------------------------------------------------------------------------
function buildRows(showSecondary, showAlts, searchText) {
    const rows = [];
    const q = searchText.toLowerCase();

    for (const player of allPlayers) {
        const mc = player.main_character;
        const sc = player.secondary_character;
        if (mc) {
            rows.push({
                player_id: player.player_id,
                display_name: player.display_name,
                character_name: mc.character_name,
                class_name: mc.class_name || '',
                spec_name: mc.spec_name || '',
                role_name: mc.role_name || '',
                rank_name: player.rank_name,
                rank_level: player.rank_level,
                item_level: mc.item_level || 0,
                armory_url: mc.armory_url,
                class_color: CLASS_COLORS[mc.class_name] || '#e8e8e8',
                role_emoji: ROLE_EMOJIS[mc.role_name] || '',
                row_type: 'main',
            });
        }
        if (showSecondary && sc) {
            rows.push({
                player_id: player.player_id,
                display_name: player.display_name,
                character_name: sc.character_name,
                class_name: sc.class_name || '',
                spec_name: sc.spec_name || '',
                role_name: sc.role_name || '',
                rank_name: player.rank_name,
                rank_level: player.rank_level,
                item_level: sc.item_level || 0,
                armory_url: sc.armory_url,
                class_color: CLASS_COLORS[sc.class_name] || '#e8e8e8',
                role_emoji: ROLE_EMOJIS[sc.role_name] || '',
                row_type: 'secondary',
            });
        }
        if (showAlts && player.characters) {
            const skipIds = new Set([
                mc ? mc.character_id : null,
                sc ? sc.character_id : null,
            ]);
            for (const char of player.characters) {
                if (skipIds.has(char.character_id)) continue;
                rows.push({
                    player_id: player.player_id,
                    display_name: player.display_name,
                    character_name: char.character_name,
                    class_name: char.class_name || '',
                    spec_name: char.spec_name || '',
                    role_name: char.role_name || '',
                    rank_name: player.rank_name,
                    rank_level: player.rank_level,
                    item_level: char.item_level || 0,
                    armory_url: char.armory_url,
                    class_color: CLASS_COLORS[char.class_name] || '#e8e8e8',
                    role_emoji: ROLE_EMOJIS[char.role_name] || '',
                    row_type: 'alt',
                });
            }
        }
    }

    // Filter
    const filtered = q
        ? rows.filter(r =>
            r.display_name.toLowerCase().includes(q) ||
            r.character_name.toLowerCase().includes(q) ||
            r.class_name.toLowerCase().includes(q) ||
            r.spec_name.toLowerCase().includes(q) ||
            r.role_name.toLowerCase().includes(q)
          )
        : rows;

    // Sort
    filtered.sort((a, b) => {
        const av = sortCol === 'item_level' || sortCol === 'rank_level'
            ? (a[sortCol] || 0)
            : (a[sortCol] || '').toString().toLowerCase();
        const bv = sortCol === 'item_level' || sortCol === 'rank_level'
            ? (b[sortCol] || 0)
            : (b[sortCol] || '').toString().toLowerCase();
        if (av < bv) return -sortDir;
        if (av > bv) return sortDir;
        return 0;
    });

    return filtered;
}

function renderRoster() {
    const showSecondary = document.getElementById('show-secondary').checked;
    const showAlts = document.getElementById('show-alts').checked;
    const searchText = document.getElementById('roster-search').value;
    const rows = buildRows(showSecondary, showAlts, searchText);
    const tbody = document.getElementById('roster-tbody');
    const empty = document.getElementById('roster-empty');

    if (rows.length === 0) {
        tbody.innerHTML = '';
        document.getElementById('roster-table').style.display = 'none';
        empty.style.display = '';
        return;
    }

    document.getElementById('roster-table').style.display = '';
    empty.style.display = 'none';

    const TYPE_EMOJI = { main: 'â­', secondary: 'ðŸ”·', alt: 'âšª' };
    const TYPE_LABEL = { main: 'Main', secondary: 'Secondary', alt: 'Alt' };
    tbody.innerHTML = rows.map(r => `
        <tr class="${r.row_type !== 'main' ? 'roster-row--alt' : ''}">
            <td class="col-type" title="${TYPE_LABEL[r.row_type]}">${TYPE_EMOJI[r.row_type]}</td>
            <td class="col-player">${esc(r.display_name)}</td>
            <td class="col-character">
                <span style="color:${r.class_color};font-weight:600">${esc(r.character_name)}</span>
            </td>
            <td class="col-class">${esc(r.class_name)}</td>
            <td class="col-spec">${esc(r.spec_name)}</td>
            <td class="col-role">${r.role_emoji} ${esc(r.role_name)}</td>
            <td class="col-rank">${esc(r.rank_name)}</td>
            <td class="col-ilvl num-col">${r.item_level || 'â€”'}</td>
            <td class="col-armory">
                ${r.armory_url
                    ? `<a href="${esc(r.armory_url)}" target="_blank" rel="noopener" class="armory-link" title="Armory">ðŸ”—</a>`
                    : ''}
            </td>
        </tr>
    `).join('');
}

// ---------------------------------------------------------------------------
// Composition section
// ---------------------------------------------------------------------------
function renderComposition() {
    // Role counts from mains only
    const roleCounts = { "Tank": 0, "Healer": 0, "Melee DPS": 0, "Ranged DPS": 0 };
    const classCounts = {};

    for (const player of allPlayers) {
        const mc = player.main_character;
        if (!mc) continue;
        if (mc.role_name && roleCounts.hasOwnProperty(mc.role_name)) {
            roleCounts[mc.role_name]++;
        }
        if (mc.class_name) {
            classCounts[mc.class_name] = (classCounts[mc.class_name] || 0) + 1;
        }
    }

    // Compute effective DPS targets with balancing (total DPS target = 14)
    const effectiveTargets = { ...ROLE_TARGETS };
    const meleeCnt = roleCounts["Melee DPS"];
    const rangedCnt = roleCounts["Ranged DPS"];
    if (meleeCnt > ROLE_TARGETS["Melee DPS"]) {
        effectiveTargets["Ranged DPS"] = Math.max(0, DPS_TOTAL_TARGET - meleeCnt);
    } else if (rangedCnt > ROLE_TARGETS["Ranged DPS"]) {
        effectiveTargets["Melee DPS"] = Math.max(0, DPS_TOTAL_TARGET - rangedCnt);
    }

    // Build class â†’ spec â†’ count per role (mains only)
    const classSpecByRole = {};
    for (const player of allPlayers) {
        const mc = player.main_character;
        if (!mc || !mc.role_name) continue;
        const role = mc.role_name;
        if (!classSpecByRole[role]) classSpecByRole[role] = {};
        const cls = mc.class_name || 'Unknown';
        if (!classSpecByRole[role][cls]) classSpecByRole[role][cls] = {};
        const spec = mc.spec_name || 'Unknown';
        classSpecByRole[role][cls][spec] = (classSpecByRole[role][cls][spec] || 0) + 1;
    }

    // Role cards
    const roleCardsEl = document.getElementById('role-cards');
    roleCardsEl.innerHTML = Object.entries(effectiveTargets).map(([role, target]) => {
        const count = roleCounts[role] || 0;
        let statusClass = 'role-card--danger';
        if (count >= target) statusClass = 'role-card--ok';
        else if (count === target - 1) statusClass = 'role-card--warn';
        const pct = target > 0 ? Math.min(100, Math.round((count / target) * 100)) : 100;

        // Class/spec breakdown sorted by class total desc
        const classData = classSpecByRole[role] || {};
        const classSorted = Object.entries(classData).sort((a, b) => {
            const aTotal = Object.values(a[1]).reduce((s, n) => s + n, 0);
            const bTotal = Object.values(b[1]).reduce((s, n) => s + n, 0);
            return bTotal - aTotal;
        });
        const breakdownHtml = classSorted.map(([cls, specs]) => {
            const color = CLASS_COLORS[cls] || '#e8e8e8';
            const emoji = CLASS_EMOJIS[cls] || 'âš”ï¸';
            const clsTotal = Object.values(specs).reduce((s, n) => s + n, 0);
            const specLines = Object.entries(specs)
                .sort((a, b) => b[1] - a[1])
                .map(([sp, cnt]) => `<span class="rc-spec">${esc(sp)}: ${cnt}</span>`)
                .join('');
            return `<div class="rc-class">
                <span class="rc-class__label">${emoji} <span style="color:${color}">${esc(cls)}</span> <span class="rc-class__total">(${clsTotal})</span></span>
                <div class="rc-spec-list">${specLines}</div>
            </div>`;
        }).join('');

        return `
            <div class="role-card ${statusClass}">
                <div class="role-card__icon">${ROLE_EMOJIS[role] || ''}</div>
                <div class="role-card__name">${esc(role)}</div>
                <div class="role-card__count">${count} <span class="role-card__target">/ ${target}</span></div>
                <div class="role-card__bar-wrap">
                    <div class="role-card__bar" style="width:${pct}%"></div>
                </div>
                ${breakdownHtml ? `<div class="rc-breakdown">${breakdownHtml}</div>` : ''}
            </div>
        `;
    }).join('');

    // Wowhead link
    const codes = allPlayers
        .filter(p => p.main_character?.class_name && p.main_character?.spec_name)
        .map(p => SPEC_CODES[`${p.main_character.class_name}/${p.main_character.spec_name}`])
        .filter(Boolean)
        .join('');
    const wowheadUrl = `https://www.wowhead.com/raid-comp#${codes}`;
    const btn = document.getElementById('wowhead-btn');
    btn.href = wowheadUrl;
    if (!codes) {
        btn.textContent = 'ðŸ”— View Comp on Wowhead (spec data unavailable)';
    }
}

// ---------------------------------------------------------------------------
// Sorting
// ---------------------------------------------------------------------------
document.querySelectorAll('.sort-col').forEach(th => {
    th.addEventListener('click', () => {
        const col = th.dataset.col;
        if (sortCol === col) {
            sortDir *= -1;
        } else {
            sortCol = col;
            sortDir = col === 'item_level' ? -1 : 1;
        }
        document.querySelectorAll('.sort-col').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
        th.classList.add(sortDir === 1 ? 'sort-asc' : 'sort-desc');
        renderRoster();
    });
});

// ---------------------------------------------------------------------------
// Controls
// ---------------------------------------------------------------------------
document.getElementById('show-secondary').addEventListener('change', renderRoster);
document.getElementById('show-alts').addEventListener('change', renderRoster);
document.getElementById('roster-search').addEventListener('input', renderRoster);

// ---------------------------------------------------------------------------
// Helpers
// ---------------------------------------------------------------------------
function esc(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}

// ---------------------------------------------------------------------------
// Init
// ---------------------------------------------------------------------------
loadRoster();
</script>
{% endblock %}
